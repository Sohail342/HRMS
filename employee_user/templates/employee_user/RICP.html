{% extends "sidebar.html" %}

{% block content %}
<div class="bg-gray-100 p-6">
  <div class="max-w-4xl mx-auto bg-white shadow-md rounded-lg p-6" id="formContent">
    <!-- Download PDF Button -->
    <div class="text-right mb-4">
        <button id="downloadPdfButton" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-green-600 hover:shadow-lg transition-all duration-200">
          Download PDF
        </button>
    </div>
    <h2 class="text-lg font-bold text-gray-800 mb-2">
      Risk, Internal Controls & Processes
    </h2>
    <p class="text-sm text-gray-600 mb-4">
      How I will improve productivity, quality, and speed of service while adhering strictly to the Bankâ€™s regulation and processes?
    </p>

    <div class="overflow-x-auto">
      <table class="w-full border-collapse border border-gray-300 text-sm" id="tableBody">
        <thead class="bg-gray-100">
          <tr>
            <th class="border border-gray-300 px-4 py-1 text-left">S.No.</th>
            <th class="border border-gray-300 px-4 py-2 text-left">Key Performing Indicator (KPI)</th>
            <th class="border border-gray-300 px-4 py-2 text-left">Achievement</th>
            <th class="border border-gray-300 px-4 py-2 text-center ">Weightage</th>
            <th class="border border-gray-300 px-4 py-2 text-left">Target Date</th>
            <th class="border border-gray-300 px-4 py-2 text-left">Score</th>
          </tr>
        </thead>
        <tbody id="dynamicRows">
          <!-- Dynamic rows will be added here -->
        </tbody>
        <tfoot class="bg-gray-100">
          <tr>
            <td colspan="2" class="border border-gray-300 px-4 py-2 text-left">Half Year Review (Jun 30)</td>
            <td class="border border-gray-300 px-4 py-2 text-center">
              <select class="border border-gray-300 rounded px-2 py-1 w-24">
                <option value=""></option>
                <option value="0">Outstanding</option>
                <option value="1">Very Good</option>
                <option value="2">Good</option>
                <option value="3">Needs Improvement</option>
                <option value="4">Unsatisfactory</option>
              </select>
            </td>
            <td colspan="1" class="border border-gray-300 px-4 py-2 text-left">Full Year Review</td>
            <td class="border border-gray-300 px-4 py-2 text-center">
              <select class="border border-gray-300 rounded px-2 py-1 w-24">
                <option value=""></option>
                <option value="0">Outstanding</option>
                <option value="1">Very Good</option>
                <option value="2">Good</option>
                <option value="3">Needs Improvement</option>
                <option value="4">Unsatisfactory</option>
              </select>
            </td>
            <td>
              <p class="mt-4 text-lg font-semibold"><span id="finalScore"></span></p>
            </td>
          </tr>
        </tfoot>
      </table>
    </div>

    <!-- Button to Add New Row -->
    <div class="mt-4 text-center">
      <button id="addRowButton" class="bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-green-600 hover:shadow-lg transition-all duration-200 ">Add Row</button>
    </div>
  </div>
</div>

<script>
  // Function to add a new row dynamically
  let rowCount = 1; // Initialize row count

  function addRow() {
    const row = document.createElement('tr');
    const weightage = rowCount === 1 ? '<td class="border border-gray-300 px-4 py-2 text-center">25%</td>' : '<td class="border border-gray-300 px-4 py-2 w-11 text-center"></td>';

    row.innerHTML = `
      <td class="border border-gray-300 px-4 py-2 text-center">${rowCount}</td>
      <td class="border border-gray-300 px-4 py-2">
        <input type="text" class="px-2 py-1 w-full bg-transparent focus:outline-none" placeholder="Enter KPI">
      </td>
      <td class="border border-gray-300 px-4 py-2">
        <input type="text" class="px-2 py-1 w-full bg-transparent focus:outline-none" placeholder="Enter Achievement">
      </td>
      ${weightage}
      <td class="border border-gray-300 px-4 py-2">
        <input type="text" class="px-2 py-1 w-full bg-transparent focus:outline-none" placeholder="Enter Target Date">
      </td>
      <td class="border border-gray-300 px-4 py-2 score">
        <select class="border border-gray-300 rounded px-2 py-1 w-24">
          <option value=""></option>
          <option value="0">0</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
        </select>
      </td>
    `;

    document.getElementById('dynamicRows').appendChild(row);
    rowCount++;
    const newSelect = row.querySelector('.score select');
    newSelect.addEventListener('change', calculateFinalScore);
    calculateFinalScore();
  }

  document.getElementById('addRowButton').addEventListener('click', addRow);

  function calculateFinalScore() {
    const scores = document.querySelectorAll(".score select");
    let sum = 0;
    let count = 0;

    scores.forEach((score) => {
      const scoreValue = parseInt(score.value) || 0;
      if (scoreValue > 0) {
        sum += scoreValue;
        count++;
      }
    });

    const finalScore = count > 0 ? (sum / count) * 0.25 : 0;
    const finalScoreElement = document.getElementById("finalScore");
    if (finalScoreElement) {
      finalScoreElement.textContent = finalScore > 0 ? finalScore.toFixed(2) : "";
    }
  }

  document.querySelectorAll(".score select").forEach((select) => {
    select.addEventListener("change", calculateFinalScore);
  });

  calculateFinalScore();

 // PDF Download Functionality
document.getElementById('downloadPdfButton').addEventListener('click', async () => {
  const formContent = document.getElementById('formContent');
  const clonedForm = formContent.cloneNode(true);

  // Replace input values with text content
  clonedForm.querySelectorAll('input').forEach(input => {
      const span = document.createElement('span');
      span.textContent = input.value || input.placeholder;
      span.style.cssText = window.getComputedStyle(input).cssText;
      span.style.background = 'none';
      span.style.border = 'none';
      input.replaceWith(span);
  });

  // Replace dropdown values with their selected option text
  clonedForm.querySelectorAll('select').forEach(select => {
      const selectedOption = select.options[select.selectedIndex];
      const span = document.createElement('span');
      
      // Create a text node from the selected option text and append to the span
      const textNode = document.createTextNode(selectedOption ? selectedOption.textContent : '');
      span.appendChild(textNode);
      
      span.style.cssText = window.getComputedStyle(select).cssText;
      span.style.background = 'none';
      span.style.border = 'none';
      span.style.display = 'inline-block';
      span.style.padding = '5px 10px'; // Match dropdown padding
      span.style.borderRadius = '4px';

      // Create a container for the value outside of the select
      const valueContainer = document.createElement('div');
      valueContainer.appendChild(span);
      select.parentNode.replaceChild(valueContainer, select);
      select.replaceWith(span);
  });

  // Create a container to temporarily hold the cloned form
  const container = document.createElement('div');
  container.style.position = 'absolute';
  container.style.top = '-9999px';
  container.appendChild(clonedForm);
  document.body.appendChild(container);

  try {
      // Generate canvas from the cloned form
      const canvas = await html2canvas(clonedForm, {
          scale: 2, // Higher scale for better image quality
          useCORS: true // Enable CORS to handle cross-origin resources
      });
      const imgData = canvas.toDataURL('image/png');

      // Generate the PDF and add the image
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF();
      pdf.addImage(imgData, 'PNG', 10, 10, 190, 0);
      pdf.save('form.pdf');
  } catch (error) {
      console.error('Error generating PDF:', error);
  } finally {
      // Remove the temporary container
      document.body.removeChild(container);
  }
});



</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

{% endblock %}

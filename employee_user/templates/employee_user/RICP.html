{% extends "sidebar.html" %}

{% block content %}
<div class="bg-gray-100 p-6">
  <div class="max-w-4xl mx-auto bg-white shadow-md rounded-lg p-6">
    <h2 class="text-lg font-bold text-gray-800 mb-2">
      Risk, Internal Controls & Processes
    </h2>
    <p class="text-sm text-gray-600 mb-4">
      How I will improve productivity, quality, and speed of service while adhering strictly to the Bankâ€™s regulation and processes?
    </p>

    <div class="overflow-x-auto">
      <table class="w-full border-collapse border border-gray-300 text-sm" id="tableBody">
        <thead class="bg-gray-100">
          <tr>
            <th class="border border-gray-300 px-4 py-1 text-left">S.No.</th>
            <th class="border border-gray-300 px-4 py-2 text-left">Key Performing Indicator (KPI)</th>
            <th class="border border-gray-300 px-4 py-2 text-left">Achievement</th>
            <th class="border border-gray-300 px-4 py-2 text-center ">Weightage</th>
            <th class="border border-gray-300 px-4 py-2 text-left">Target Date</th>
            <th class="border border-gray-300 px-4 py-2 text-left">Score</th>
          </tr>
        </thead>
        <tbody id="dynamicRows">
          <!-- Dynamic rows will be added here -->
        </tbody>
        <tfoot class="bg-gray-100">
          <tr>
            <td colspan="2" class="border border-gray-300 px-4 py-2 text-left">Half Year Review (Jun 30)</td>
            <td class="border border-gray-300 px-4 py-2 text-center">
              <select class="border border-gray-300 rounded px-2 py-1 w-24">
                <option value=""></option>
                <option value="0">Outstanding</option>
                <option value="1">Very Good</option>
                <option value="2">Good</option>
                <option value="3">Needs Improvement</option>
                <option value="4">Unsatisfactory</option>
              </select>
            </td>
            <td colspan="1" class="border border-gray-300 px-4 py-2 text-left">Full Year Review</td>
            <td class="border border-gray-300 px-4 py-2 text-center">
              <select class="border border-gray-300 rounded px-2 py-1 w-24">
                <option value=""></option>
                <option value="0">Outstanding</option>
                <option value="1">Very Good</option>
                <option value="2">Good</option>
                <option value="3">Needs Improvement</option>
                <option value="4">Unsatisfactory</option>
              </select>
            </td>
            <td>
              <p class="mt-4 text-lg font-semibold"><span id="finalScore"></span></p>
            </td>
          </tr>
        </tfoot>
      </table>
    </div>
    
    <!-- Button to Add New Row -->
    <div class="mt-4 text-center">
      <button id="addRowButton" class="bg-blue-500 text-white px-4 py-2 rounded-md">Add Row</button>
    </div>
  </div>
</div>

<script>
  // Function to add a new row dynamically
  let rowCount = 1; // Initialize row count

  function addRow() {
    // Create a new row
    const row = document.createElement('tr');
    
    // If this is the first row, include 25% weightage. Otherwise, don't include it.
    const weightage = rowCount === 1 ? '<td class="border border-gray-300 px-4 py-2 text-center">25%</td>' : '<td class="border border-gray-300 px-4 py-2 w-11 text-center"></td>';
    
    row.innerHTML = `
      <td class="border border-gray-300 px-4 py-2 text-center">${rowCount}</td>
      <td class="border border-gray-300 px-4 py-2">
        <input type="text" class="px-2 py-1 w-full bg-transparent focus:outline-none" placeholder="Enter KPI">
      </td>
      <td class="border border-gray-300 px-4 py-2">
        <input type="text" class="px-2 py-1 w-full bg-transparent focus:outline-none" placeholder="Enter Achievement">
      </td>
      ${weightage}
      <td class="border border-gray-300 px-4 py-2">
        <input type="text" class="px-2 py-1 w-full bg-transparent focus:outline-none" placeholder="Enter Target Date">
      </td>
      <td class="border border-gray-300 px-4 py-2 score">
        <select class="border border-gray-300 rounded px-2 py-1 w-24">
          <option value=""></option>
          <option value="0">0</option>
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
        </select>
      </td>
    `;
    
    // Append the row to the table body
    document.getElementById('dynamicRows').appendChild(row);
    
    // Increment row count for the next row
    rowCount++;
    
    // Add event listeners to the newly added select elements for real-time score calculation
    const newSelect = row.querySelector('.score select');
    newSelect.addEventListener('change', calculateFinalScore);
    
    // Recalculate final score after adding a row
    calculateFinalScore();
  }

  // Event listener for the add row button
  document.getElementById('addRowButton').addEventListener('click', addRow);
  
  // Function to calculate the final score dynamically
  function calculateFinalScore() {
    const scores = document.querySelectorAll(".score select");
    let sum = 0;
    let count = 0;
  
    // Loop through all the score select fields and sum their values
    scores.forEach((score) => {
      const scoreValue = parseInt(score.value) || 0;
      if (scoreValue > 0) {
        sum += scoreValue;
        count++;
      }
    });
  
    // Apply the formula: SUM(all values) / COUNT(all values) * 25%
    const finalScore = count > 0 ? (sum / count) * 0.25 : 0;
  
    // Set the final score in an element with ID finalScore
    const finalScoreElement = document.getElementById("finalScore");
    if (finalScoreElement) {
      finalScoreElement.textContent = finalScore > 0 ? finalScore.toFixed(2) : ""; 
    }
  }
  
  // Add event listeners to all score fields for recalculating final score
  document.querySelectorAll(".score select").forEach((select) => {
    select.addEventListener("change", calculateFinalScore);
  });

  // Initial calculation
  calculateFinalScore();
</script>
{% endblock %}

{% extends "sidebar.html" %}
{% load static %}

{% block content %}
<body class="p-8 bg-gray-100">
     <!-- Leave Application Form -->
     <div class="max-w-screen-md mx-auto p-6 bg-white shadow-lg rounded-lg my-10">
        <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Application Form</h2>
    
        <!-- Approval Type -->
        <div>
            <label for="approval_type_option" class="block text-sm font-medium text-gray-700">Approval Type:</label>
            <select id="approval_type_option" name="approval_type_option" class="mt-1 p-3 w-full border border-blue-500 rounded-lg focus:outline-none focus:border-blue-700 transition-colors duration-300 shadow-md">
                <option value="">Select Approval Type</option>
                <option value="Approval/Permission">Approval/Permission</option>
                <option value="Post Facto Approval">Post Facto Approval</option>
            </select>
        </div>
    
        <!-- Sub Category -->
        <div class="mt-4">
            <label for="category_type_option" class="block text-sm font-medium text-gray-700">Sub Category</label>
            <select id="category_type_option" name="category_type_option" class="mt-1 p-3 w-full border border-blue-500 rounded-lg focus:outline-none focus:border-blue-700 transition-colors duration-300 shadow-md">
                <option value="">Select Category</option>
                <option value="Self">Self</option>
                <option value="Family/Dependents">Family/Dependents</option>
            </select>
        </div>

        <!-- Self Section (Hidden by Default) -->
        <div id="self_details" class="mt-4 hidden">
            <div class="mt-4">
                <label for="self_absence_employee" class="block text-sm font-medium text-gray-700">Employee SAP ID:</label>
                <div class="flex space-x-2">
                    <input type="number" id="self_absence_employee" class="mt-1 p-3 flex-1 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm" required placeholder="e.g. 83787">
                    <button class="fetch-employee-btn px-4 py-2 bg-blue-500 text-white font-semibold rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        Fetch
                    </button>
                </div>
            </div>
        </div>

        <!-- Family Details Section (Hidden by Default) -->
        <div id="family_details" class="mt-4 hidden">
            <label class="block text-sm font-medium text-gray-700">Family Member Details:</label>
            
            <input type="text" id="family_member_name" placeholder="Enter Name" class="mt-1 p-3 w-full border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm">
            
            <input type="text" id="family_member_cnic" placeholder="Enter CNIC" maxlength="13" class="mt-3 p-3 w-full border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm">

            <select id="family_member_relation" class="mt-3 p-3 w-full border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm">
                <option value="">Select Relationship</option>
                <option value="Father">Father</option>
                <option value="Mother">Mother</option>
                <option value="Son">Son</option>
                <option value="Daughter">Daughter</option>
                <option value="Wife">Wife</option>
                <option value="Husband">Husband</option>
            </select>

            <!-- Employee Backup SAP ID -->
            <div class="mt-4">
                <label for="family_absence_employee" class="block text-sm font-medium text-gray-700">Employee SAP ID:</label>
                <div class="flex space-x-2">
                    <input type="number" id="family_absence_employee" class="mt-1 p-3 flex-1 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm" required placeholder="e.g. 83787">
                    <button class="fetch-employee-btn px-4 py-2 bg-blue-500 text-white font-semibold rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        Fetch
                    </button>
                </div>
            </div>
        </div>

        <!-- Toast Messages -->
        <div id="errorToast" class="fixed bottom-5 right-5 hidden bg-red-500 text-white text-base px-6 py-3 rounded-xl shadow-lg transition-opacity duration-300">
            Employee with this SAP ID not found!
        </div>

        <div id="successToast" class="fixed bottom-5 right-5 hidden bg-green-500 text-white text-base px-6 py-3 rounded-xl shadow-lg transition-opacity duration-300">
            Employee found!
        </div>
    
    </div>
    

    <div id="download_letter" class="max-w-screen-md mx-auto bg-white p-10">
        <!-- Header Section -->
        <div class="mb-4">
            <div class="flex justify-between items-center">
                <div>
                    <img src="{% static 'reporting/images/NBP.png' %}" alt="NBP Logo" class="h-21">
                </div>
                <div class="text-right mt-9">
                    <p class="font-semibold pr-6">Operations Group</p>
                </div>
            </div>
            <!-- Full-width border under the header section -->
            <hr class="border-t border-gray-400">
            <div class="text-sm mt-0 flex justify-between items-center">
                <p class="font-semibold">National Bank of Pakistan</p>
                <p class="font-semibold pr-3">Administration Division</p>
            </div>
            <div class="text-sm mt-4 mb-8">
                <p class="mt-6">No.OPG/ADMN/2024/SAPID{{employee.SAP_ID}}</p>
                <p class="font-semibold">Date: {{current_time |date:"F j, Y" }}</p> 
                <div class="mt-4">
                    <p>The Senior Welfare Officer</p>
                    <p>Staff Loan & Welfare Wing</p>
                    <p>HR Management Group</p>
                    <p>National Bank of Pakistan</p>
                    <p>Head Office Karachi</p>
                </div>
            </div>
        </div>


        <!-- Body Text -->
        <p class="mb-1" style="text-align: justify;">
            Dear Sir,
        </p>
        <p class="mb-4 pl-8" style="text-align: justify;">
            <b><u><span id="approval_type_text">______________</span> FOR HOSPITALIZATION AT ZIAUDDIN HOSPITAL, CLIFTON, KARACHI. <span class="upper font-bold" id="family_member"></span>
                <span id="employee_name">_____________</span>, <span id="employee_grade">_____________</span>, SAP ID: <span id="employee_sapID">_____________</span>, OPERATIONS GROUP, NBP, HEAD-OFFICE, KARACHI.</b></u>
        </p>
       
        <p class="mb-4 pl-8" style="text-align: justify;">
            Enclosed please find a self-explanatory Doctor's advice dated 30-12-2021 on the captioned subject.
        </p>
        <p class="mb-4 pl-8" style="text-align: justify;">
            Kindly accord necessary approval for Ms. Rameen (CNIC No. 45504-8403706-2, W/o Zohaib Ghani Larik, 
            SVP, SAP ID: 7099 as advised as by Concerned Doctor. (Reference Letter Attached).
        </p>
        <p class="mb-4 pl-8" style="text-align: justify;">
            Kindly arrange to issue necessary permission as per Bank rules.
        </p>
        <p class="mb-4 mt-8" style="text-align: justify;">
            Yours faithfully,
        </p>
        

        <!-- Recipient Information Section -->
        <div class="mt-6">
            <p class="font-semibold">Mr. {{employee.name}}</p>
            <p class="text-sm">OG-II/{{employee.employee_type}}</p>
            <p class="text-sm">SAP ID: {{employee.SAP_ID}}</p>
            <p class="text-sm">NBP, RO, Faisalabad.</p>
        </div>

        <div class="mt-6">
            <p>Encl: a.a</p>
        </div>

        <!-- Footer Section -->
        <hr class="border-t border-gray-400 mt-20 mb-2">
        <div class="text-center text-xs text-gray-600">
            <p class="font-semibold">National Bank of Pakistan</p>
            <p>Head Office: I.I. Chundrigar Road, Karachi. Ph: 9212100 (50 lines) Website: www.nbp.com.pk</p>
        </div>
    </div>


    <div class="mt-3 mb-5 text-center">
        <button type="button" id="download" class="bg-blue-500 text-white px-6 py-2 rounded-lg shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300">Download as a PDF</button>
    </div>
</body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
    document.getElementById('download').addEventListener('click', function() {      

        const form = document.getElementById('form_type');
           
            const element = document.getElementById('download_letter');
            
            // Options for generating PDF
            const options = {
                margin:       10,
                filename:     '{{employee.name}}.pdf',
                image:        { type: 'jpeg', quality: 0.98 },
                html2canvas:  { scale: 2 }, // For high-quality rendering
                jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
            };
        
            // Generate the PDF
            html2pdf().from(element).set(options).save().then(() => {
                // You can add some code here if needed after the PDF is saved
            });
    });


    // Dynamic text
    document.getElementById('approval_type_option').addEventListener('change', function() {
        const leaveTypeTextElements = document.querySelectorAll('#approval_type_text');
        leaveTypeTextElements.forEach(element => {
            element.textContent = this.value || "______________";
        });
    });

    // Family details
    function updateFamilyMemberDetails() {
        const categoryType = document.getElementById('category_type_option').value;
        const familyMemberSpan = document.getElementById('family_member');
    
        if (categoryType === "Self") {
            familyMemberSpan.classList.add('hidden');
            return; // Stop execution if "Self" is selected
        } else {
            familyMemberSpan.classList.remove('hidden');
        }
    
        const name = document.getElementById('family_member_name').value.trim();
        const cnic = document.getElementById('family_member_cnic').value.trim();
        const relation = document.getElementById('family_member_relation').value;
    
        // Format: "MS/MRS Family Member Name, CNIC NO: 9898239823822, M/O (Relationship)"
        const formattedText = name && cnic && relation 
            ? `MS/MRS ${name}, CNIC NO: ${cnic}, (${relation})` 
            : ""; 
    
        familyMemberSpan.textContent = formattedText;
    }
    
    // Attach event listeners to update span when any input changes
    document.getElementById('family_member_name').addEventListener('input', updateFamilyMemberDetails);
    document.getElementById('family_member_cnic').addEventListener('input', updateFamilyMemberDetails);
    document.getElementById('family_member_relation').addEventListener('change', updateFamilyMemberDetails);
    document.getElementById('category_type_option').addEventListener('change', updateFamilyMemberDetails);
    
    


    // Employee data fetch (Ajax Request)
    document.querySelectorAll('.fetch-employee-btn').forEach(button => {
        button.addEventListener('click', function() {
            const inputField = this.previousElementSibling;  // Get the related input field
            const sapId = inputField.value.trim();

            if (!sapId) {
                showErrorToast("Please enter an SAP ID before fetching data.");
                return;
            }

            fetch(`/get_employee/?sap_id=${sapId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.employee_name && data.designation) {
                        document.getElementById('employee_name').textContent = "MRS/MS " + data.employee_name;
                        document.getElementById('employee_sapID').textContent = sapId;
                        document.getElementById('employee_grade').textContent = data.employee_grade;
                        showSuccessToast("Employee found!");
                    } else {
                        resetPlaceholders();
                    }
                })
                .catch(error => {
                    showErrorToast("Employee with this SAP ID not found!");
                });
        });
    });

    // Reset placeholders when no employee is found
    function resetPlaceholders() {
        document.getElementById('employee_name').textContent = "_____________";
        document.getElementById('employee_designation').textContent = "_____________";
        document.getElementById('employee_sapID').textContent = "_____________";
        document.getElementById('employee_grade').textContent = "_____________";
    }

    // Show Error Toast
    function showErrorToast(message) {
        const toast = document.getElementById('errorToast');
        toast.textContent = message;
        toast.classList.remove('hidden', 'opacity-0');
        toast.classList.add('opacity-100');

        setTimeout(() => {
            toast.classList.add('hidden');
        }, 3000);
    }

    // Show Success Toast
    function showSuccessToast(message) {
        const toast = document.getElementById('successToast');  // Fixed typo
        toast.textContent = message;
        toast.classList.remove('hidden', 'opacity-0');
        toast.classList.add('opacity-100');

        setTimeout(() => {
            toast.classList.add('hidden');
        }, 3000);
    }

    // Show/hide sections based on category selection
    document.getElementById('category_type_option').addEventListener('change', function() {
        const familyDetails = document.getElementById('family_details');
        const selfDetails = document.getElementById('self_details');

        if (this.value === "Family/Dependents") {
            familyDetails.classList.remove('hidden');
            selfDetails.classList.add('hidden');
        } else if (this.value === "Self") {
            selfDetails.classList.remove('hidden');
            familyDetails.classList.add('hidden');
        } else {
            selfDetails.classList.add('hidden');
            familyDetails.classList.add('hidden');
        }
    });


// Max disgits
document.getElementById('family_member_cnic').addEventListener('input', function (e) {
    this.value = this.value.replace(/\D/g, '').slice(0, 13); // Allow only numbers & max 13 characters
});


</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.js"></script>
{% endblock content %}

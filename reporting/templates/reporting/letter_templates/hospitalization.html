{% extends "sidebar.html" %}
{% load static %}

{% block content %}
<body class="p-8 bg-gray-100">
    <!-- Main Container with Two-Column Layout -->
    <div class="flex flex-col lg:flex-row gap-6 max-w-screen-xl mx-auto">
        <!-- Left Column - Application Form -->
        <div class="w-full lg:w-5/12 p-6 bg-white shadow-lg rounded-lg my-4">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Application Form</h2>

            <!-- Employee SAP ID Field at the top -->
            <div class="mb-4">
                <label for="employee_sap_id" class="block text-sm font-medium text-gray-700">Employee SAP ID:</label>
                <div class="flex space-x-2 w-10/12">
                    <input type="number" id="employee_sap_id" class="p-1.5 flex-1 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm sap-id-input" required placeholder="e.g. 83787">
                    <button class="fetch-employee-btn px-2 py-1 bg-blue-500 text-white font-semibold rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                        Fetch
                    </button>
                </div>
            </div>

            <!-- Form Grid Layout -->
            <div class="grid grid-cols-1 md:grid-cols-1 gap-4">
               
                <!-- Hidden Hospital Advice Date Field -->
                <div id="hospital_advice_date" class="hidden">
                    <label for="hospital_advice_date_input" class="block text-sm font-medium text-gray-700">Hospital Advice Date:</label>
                    <input type="date" id="hospital_advice_date_input" class="mt-1 p-1.5 w-10/12 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm">
                </div>
            </div>

            <!-- Self Section (Hidden by Default) -->
            <div id="self_details" class="mt-4 hidden">
                <div class="grid grid-cols-1 gap-2">
                    <div>
                        <label for="self_absence_employee" class="block text-sm font-medium text-gray-700">Employee SAP ID:</label>
                        <div class="flex space-x-2 w-10/12">
                            <input type="number" id="self_absence_employee" class="p-1.5 flex-1 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm sap-id-input" required placeholder="e.g. 83787">
                            <button class="fetch-employee-btn px-2 py-1 bg-blue-500 text-white font-semibold rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                Fetch
                            </button>
                        </div>
                    </div>

                    <div>
                        <label for="self_purpose" class="block text-sm font-medium text-gray-700">Purpose:</label>
                        <div class="flex space-x-2 w-10/12">
                            <select id="self_purpose" class="p-1.5 flex-1 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm">
                                <option value="">Select Purpose</option>
                                {% for purpose in purposes %}
                                    <option value="{{ purpose.purpose_name }}">{{ purpose.purpose_name }}</option>
                                {% endfor %}
                            </select>
                            <button type="button" id="add_purpose_btn" class="px-2 py-1 bg-blue-500 text-white font-semibold rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <div>
                        <label for="self_hospital" class="block text-sm font-medium text-gray-700">Hospital Name:</label>
                        <div class="flex space-x-2 w-10/12">
                            <select id="self_hospital" class="p-1.5 flex-1 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm">
                                <option value="">Select Hospital</option>
                                {% for hospital in hospital_name %}
                                    <option value="{{ hospital.hospital_name }}">{{ hospital.hospital_name }}</option>
                                {% endfor %}
                            </select>
                            <button type="button" id="add_hospital_btn" class="px-2 py-1 bg-blue-500 text-white font-semibold rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Family Details Section (Hidden by Default) -->
            <div id="family_details" class="mt-4 hidden">
                <label class="block text-sm font-medium text-gray-700 mb-2">Family Member Details:</label>
                
                <div class="grid grid-cols-1 gap-2">
                    <!-- Relationship Field -->
                    <div>
                        <label for="family_member_relation" class="block text-sm font-medium text-gray-700">Relationship:</label>
                        <select id="family_member_relation" class="p-1.5 w-10/12 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm">
                            <option value="">Select Relationship</option>
                            {% if employee_type == "Regular" %}
                                <option value="Father of">Father of</option>
                                <option value="Mother of">Mother of</option>
                                <option value="Son of">Son of</option>
                                <option value="Daughter of">Daughter of</option>
                                <option value="Wife of">Wife of</option>
                                <option value="Husband of">Husband of</option> 
                            {% elif  employee_type == "Contractual" %}
                                <option value="Son of">Son of</option>
                                <option value="Daughter of">Daughter of</option>
                                <option value="Wife of">Wife of</option>
                                <option value="Husband of">Husband of</option> 
                            {% else %}
                                <option value="">Not Allowed</option>
                            {% endif %} 
                        </select>
                    </div>

                    <!-- Family Member Name Field -->
                    <div>
                        <label for="family_member_name" class="block text-sm font-medium text-gray-700">Family Member Name:</label>
                        <input type="text" id="family_member_name" placeholder="Enter Only Name" class="p-1.5 w-10/12 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm">
                    </div>

                    <!-- CNIC Field -->
                    <div>
                        <label for="family_member_cnic" class="block text-sm font-medium text-gray-700">CNIC:</label>
                        <input type="text" id="family_member_cnic" placeholder="Enter CNIC" maxlength="13" class="p-1.5 w-10/12 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm">
                    </div>
                    
                    <!-- Additional Family Member Fields have been removed as requested -->
                    
                    <!-- Save Family Member Button -->
                    <div class="mt-2">
                        <button id="save_family_member" class="bg-blue-500 hover:bg-blue-600 text-white py-1 px-3 rounded-md text-sm transition duration-300 ease-in-out">
                            Save Family Member
                        </button>
                        <span id="family_member_status" class="ml-2 text-sm"></span>
                    </div>

                    <!-- Purpose Field -->
                    <div>
                        <label for="family_purpose" class="block text-sm font-medium text-gray-700">Purpose:</label>
                        <div class="flex space-x-2 w-10/12">
                            <select id="family_purpose" class="p-1.5 flex-1 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm">
                                <option value="">Select Purpose</option>
                                {% for purpose in purposes %}
                                    <option value="{{ purpose.purpose_name }}">{{ purpose.purpose_name }}</option>
                                {% endfor %}
                            </select>
                            <button type="button" id="add_family_purpose_btn" class="px-2 py-1 bg-blue-500 text-white font-semibold rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Hospital Name Field -->
                    <div>
                        <label for="family_hospital" class="block text-sm font-medium text-gray-700">Hospital Name:</label>
                        <div class="flex space-x-2 w-10/12">
                            <select id="family_hospital" class="p-1.5 flex-1 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm">
                                <option value="">Select Hospital</option>
                                {% for hospital in hospital_name %}
                                    <option value="{{ hospital.hospital_name }}">{{ hospital.hospital_name }}</option>
                                {% endfor %}
                            </select>
                            <button type="button" id="add_family_hospital_btn" class="px-2 py-1 bg-blue-500 text-white font-semibold rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm flex items-center">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    <!-- Employee SAP ID Field -->
                    <div>
                        <label for="family_absence_employee" class="block text-sm font-medium text-gray-700">Employee SAP ID:</label>
                        <div class="flex space-x-2 w-10/12">
                            <input type="number" id="family_absence_employee" class="p-1.5 flex-1 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm sap-id-input" required placeholder="e.g. 83787">
                            <button class="fetch-employee-btn px-2 py-1 bg-blue-500 text-white font-semibold rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300 text-sm">
                                Fetch
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Form Grid Layout -->
            <div class="grid grid-cols-1 gap-2 mt-4">
                <!-- Approval Type -->
                <div>
                    <label for="approval_type_option" class="block text-sm font-medium text-gray-700">Approval Type:</label>
                    <select id="approval_type_option" name="approval_type_option" class="p-1.5 w-10/12 border border-blue-500 rounded-md focus:outline-none focus:border-blue-700 transition-colors duration-300 shadow-sm text-sm">
                        <option value="">Select Approval Type</option>
                        <option value="Approval/Permission">Approval/Permission</option>
                        <option value="Post Facto Approval">Post Facto Approval</option>
                    </select>
                </div>

                <!-- Sub Category -->
                <div>
                    <label for="category_type_option" class="block text-sm font-medium text-gray-700">Sub Category</label>
                    <select id="category_type_option" name="category_type_option" class="p-1.5 w-10/12 border border-blue-500 rounded-md focus:outline-none focus:border-blue-700 transition-colors duration-300 shadow-sm text-sm">
                        <option value="">Select Category</option>
                        <option value="Self">Self</option>
                        <option value="Family/Dependents">Family/Dependents</option>
                    </select>
                </div>

                <!-- Hidden Hospital Advice Date Field -->
                <div id="hospital_advice_date" class="hidden">
                    <label for="hospital_advice_date_input" class="block text-sm font-medium text-gray-700">Hospital Advice Date:</label>
                    <input type="date" id="hospital_advice_date_input" class="p-1.5 w-10/12 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm">
                </div>
            </div>

            <!-- Admin Signature Selection -->
            <div class="mt-4">
                <label for="form_type" class="block text-sm font-medium text-gray-700">Admin Signature:</label>
                <select id="form_type" name="form_type" class="p-1.5 w-10/12 border border-blue-500 rounded-md focus:outline-none focus:border-blue-700 transition-colors duration-300 shadow-sm text-sm">
                    <option value="">Select Admin Signature</option>
                    {% for employee in admin_signuture %}
                        <option value="{{ employee.SAP_ID }}">{{ employee.employee_name }} ({{ employee.SAP_ID }})</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Action Buttons -->
            <div class="mt-6 flex justify-center space-x-4">
                <button type="button" id="download" class="bg-blue-500 text-white px-4 py-1.5 rounded-md shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300 text-sm font-medium transition-colors duration-300">
                    <span class="flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        Download as PDF
                    </span>
                </button>
                <button type="button" id="save_to_cloudinary" class="bg-green-500 text-white px-4 py-1.5 rounded-md shadow-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300 text-sm font-medium transition-colors duration-300">
                    <span class="flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                        </svg>
                        Save
                    </span>
                </button>
            </div>
        </div>

        <!-- Right Column - Dynamic Letter Preview -->
        <div class="w-full lg:w-7/12 bg-white shadow-lg rounded-lg my-4 overflow-auto">
            <div id="download_letter" class="p-10" style="position: relative; min-height: 1123px; display: flex; flex-direction: column; page-break-inside: avoid;">
                <!-- Header Section -->
                <div class="mb-4">
                    <div class="flex justify-between items-center">
                        <div>
                            <img src="{% static 'reporting/images/NBP.png' %}" alt="NBP Logo" class="h-21">
                        </div>
                        <div class="text-right mt-9">
                            <p class="font-semibold pr-6">Operations Group</p>
                        </div>
                    </div>
                    <!-- Full-width border under the header section -->
                    <hr class="border-t border-gray-400">
                    <div class="text-sm mt-0 flex justify-between items-center">
                        <p class="font-semibold">National Bank of Pakistan</p>
                        <p class="font-semibold pr-3">Administration Division</p>
                    </div>
                    <div class="text-sm mt-4 mb-8">
                        <p class="mt-6">No.OPG/ADMN/<span id="letter_header_sapid">{{employee.SAP_ID}}</span>/{{current_time | date:"Y"}}/</p>
                        <p class="font-semibold">Date: {{current_time |date:"F j, Y" }}</p> 
                        <div class="mt-4">
                            <p>The Senior Welfare Officer</p>
                            <p>Staff Loan & Welfare Wing</p>
                            <p>HR Management Group</p>
                            <p>National Bank of Pakistan</p>
                            <p>Head Office Karachi</p>
                        </div>
                    </div>
                </div>


                <!-- Body Text -->
                <p class="mb-1" style="text-align: justify;">
                    Dear Sir,
                </p>
                <p class="mb-4" style="text-align: justify; text-transform: uppercase;">
                    <b><span id="approval_type_text">______________</span> FOR <span id="purpose_text">_____________</span> AT <span id="hospital_text">_____________</span> <span class="upper font-bold" id="family_member"></span>
                        <span id="employee_name">_____________</span> (CNIC: <span id="employee_cnic">_____________</span>) <span id="employee_grade">_____________</span>, SAP ID: <span id="employee_sapID">_____________</span>, OPERATIONS GROUP, NBP, HEAD-OFFICE, KARACHI.</b>
                </p>
               
                <p class="mb-4" style="text-align: justify;" id="doctors_advice_text">
                    <span id="doctors_advice_with_date">Enclosed please find a self-explanatory Doctor's advice dated <span id="hospital_advice_date_text">_____________</span> on the captioned subject.</span>
                </p>
                <p class="mb-4" style="text-align: justify;" id="medical_bill_text">
                    We enclose herewith Medical bill of  <span id="employee_name_text"></span>, <span id="employee_grade_text"></span>, SAP ID: <span id="employee_sapID_text"></span>, along with its enclosure for issuance of Post Facto Approval for reimbursement of his medical bill to the above captioned executive as per bank policy.
                </p>
                <p class="mb-4" style="text-align: justify;" id="family_approval_text">
                    Kindly accord necessary approval for <span id="family_member_name_text">_____________</span> (CNIC No. <span id="family_member_cnic_text">_____________</span>, <span id="family_member_relation_text">_____________</span> <span id="employee_name_relation">_____________</span>, <span id="employee_grade_relation">_____________</span>, SAP ID: <span id="employee_sapid_relation">_____________</span>) as advised by Concerned Doctor. (Reference Letter Attached).
                </p>
                <p class="mb-4" style="text-align: justify;">
                    Kindly arrange to issue necessary permission as per Bank rules.
                </p>
                <p class="mb-4 mt-8" style="text-align: justify;">
                    Yours faithfully,
                </p>

                <!-- Signature Section -->
                <div id="employee-details" class="w-full mt-12">
                    <!-- Data will be inserted here dynamically-->
                </div>

                <div class="mt-6">
                    <p>Encl: a.a</p>
                </div>

                <!-- Footer Section -->
                <div style="position: relative; margin-top: auto; left: 0; right: 0; width: 100%;" class="footer">
                    <hr class="border-t border-gray-400 mb-2">
                    <div class="text-center text-xs text-gray-600">
                        <p class="font-semibold">National Bank of Pakistan</p>
                        <p>Head Office: I.I. Chundrigar Road, Karachi. Ph: 9212100 (50 lines)</p>
                        <p>Website: www.nbp.com.pk</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Messages -->
    <div id="errorToast" class="fixed bottom-5 right-5 hidden bg-red-500 text-white text-base px-4 py-2 rounded-lg shadow-lg transition-opacity duration-300 z-50">
        Employee with this SAP ID not found!
    </div>

    <div id="successToast" class="fixed bottom-5 right-5 hidden bg-green-500 text-white text-base px-4 py-2 rounded-lg shadow-lg transition-opacity duration-300 z-50">
        Employee found!
    </div>
    
    <!-- Modal for adding new purpose -->
    <div id="purposeModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4 transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">Add New Purpose</h3>
                <button type="button" class="close-modal text-gray-400 hover:text-gray-500">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="mb-4">
                <label for="new_purpose_name" class="block text-sm font-medium text-gray-700 mb-1">Purpose Name</label>
                <input type="text" id="new_purpose_name" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none">
            </div>
            <div class="flex justify-end space-x-3">
                <button type="button" class="close-modal px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">Cancel</button>
                <button type="button" id="save_purpose_btn" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">Save</button>
            </div>
        </div>
    </div>
    
    <!-- Modal for adding new hospital -->
    <div id="hospitalModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden flex items-center justify-center z-50">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md mx-4 transform transition-all">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">Add New Hospital</h3>
                <button type="button" class="close-modal text-gray-400 hover:text-gray-500">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="mb-4">
                <label for="new_hospital_name" class="block text-sm font-medium text-gray-700 mb-1">Hospital Name</label>
                <input type="text" id="new_hospital_name" class="w-full p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none">
            </div>
            <div class="flex justify-end space-x-3">
                <button type="button" class="close-modal px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400">Cancel</button>
                <button type="button" id="save_hospital_btn" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">Save</button>
            </div>
        </div>
    </div>
</body>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
    // Function to prepare the document for PDF generation
    function prepareDocumentForPDF() {
        const form = document.getElementById('form_type');
        form.style.visibility = 'hidden';
        
        return {
            element: document.getElementById('download_letter'),
            form: form
        };
    }
    
    // Function to restore document after PDF generation
    function restoreDocumentAfterPDF(docState) {
        if (!docState) return;
        docState.form.style.visibility = 'visible';
    }
    
    // Download PDF button click handler
    document.getElementById('download').addEventListener('click', function() {      
        const docState = prepareDocumentForPDF();
        
        // Options for generating PDF
        const options = {
            filename: '{{employee.name}}.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 }, // For high-quality rendering
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
            pagebreak: { mode: ['avoid-all', 'css', 'legacy'], before: '.page-break-before', after: '.page-break-after', avoid: '.footer' },
            footer: { height: '28mm', contents: { } }
        };
    
        // Generate the PDF
        html2pdf().from(docState.element).set(options).save().then(() => {
            restoreDocumentAfterPDF(docState);
        });
    });
    
    // Save to Cloudinary button click handler
    document.getElementById('save_to_cloudinary').addEventListener('click', function() {
        const docState = prepareDocumentForPDF();
        
        // Show loading indicator
        const loadingToast = document.createElement('div');
        loadingToast.className = 'fixed bottom-5 right-5 bg-blue-500 text-white text-base px-4 py-2 rounded-lg shadow-lg transition-opacity duration-300 z-50';
        loadingToast.textContent = 'Saving to Cloudinary...';
        document.body.appendChild(loadingToast);
        
        // Options for generating PDF
        const options = {
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
            pagebreak: { mode: ['avoid-all', 'css', 'legacy'], before: '.page-break-before', after: '.page-break-after', avoid: '.footer' }
        };
    
        // Generate the PDF as blob
        html2pdf().from(docState.element).set(options).outputPdf('datauristring').then(pdfDataUri => {
            // Send the PDF data to the server
            fetch('{% url "reporting:save_pdf_to_cloudinary" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    pdf_data: pdfDataUri,
                    sap_id: '{{employee.SAP_ID}}',
                    file_name: '{{employee.name}}_hospitalization.pdf'
                })
            })
            .then(response => response.json())
            .then(data => {
                // Remove loading toast
                document.body.removeChild(loadingToast);
                
                // Show success or error toast
                const toast = document.createElement('div');
                if (data.success) {
                    toast.className = 'fixed bottom-5 right-5 bg-green-500 text-white text-base px-4 py-2 rounded-lg shadow-lg transition-opacity duration-300 z-50';
                    toast.textContent = 'Successfully saved to Cloudinary!';
                } else {
                    toast.className = 'fixed bottom-5 right-5 bg-red-500 text-white text-base px-4 py-2 rounded-lg shadow-lg transition-opacity duration-300 z-50';
                    toast.textContent = 'Error: ' + (data.error || 'Failed to save to Cloudinary');
                }
                document.body.appendChild(toast);
                
                // Remove toast after 3 seconds
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 3000);
            })
            .catch(error => {
                // Remove loading toast
                document.body.removeChild(loadingToast);
                
                // Show error toast
                const toast = document.createElement('div');
                toast.className = 'fixed bottom-5 right-5 bg-red-500 text-white text-base px-4 py-2 rounded-lg shadow-lg transition-opacity duration-300 z-50';
                toast.textContent = 'Error: ' + error.message;
                document.body.appendChild(toast);
                
                // Remove toast after 3 seconds
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 3000);
            })
            .finally(() => {
                restoreDocumentAfterPDF(docState);
            });
        });
    });


    // Dynamic text and family approval text visibility
    document.getElementById('approval_type_option').addEventListener('change', function() {
        const leaveTypeTextElements = document.querySelectorAll('#approval_type_text');
        const familyApprovalText = document.getElementById('family_approval_text');
        const categoryType = document.getElementById('category_type_option').value;

        leaveTypeTextElements.forEach(element => {
            element.textContent = this.value || "______________";
        });

        // Show family approval text only for Family/Dependents category when approval type is Approval/Permission
        if (this.value === 'Approval/Permission' && categoryType === 'Family/Dependents') {
            familyApprovalText.style.display = 'block';
        } else {
            familyApprovalText.style.display = 'none';
        }
    });

    // Update family approval text visibility when category changes
    document.getElementById('category_type_option').addEventListener('change', function() {
        const familyApprovalText = document.getElementById('family_approval_text');
        const approvalType = document.getElementById('approval_type_option').value;

        if (approvalType === 'Approval/Permission' && this.value === 'Family/Dependents') {
            familyApprovalText.style.display = 'block';
        } else {
            familyApprovalText.style.display = 'none';
        }
    });

    // Update family member details in approval text
    function updateFamilyApprovalText() {
        const nameText = document.getElementById('family_member_name_text');
        const cnicText = document.getElementById('family_member_cnic_text');
        const relationText = document.getElementById('family_member_relation_text');
        const employeeNameText = document.getElementById('employee_name_relation');
        const employeeGradeText = document.getElementById('employee_grade_relation');
        const employeeSapIdText = document.getElementById('employee_sapid_relation');

        // Get the family member details
        const familyMemberName = document.getElementById('family_member_name').value || '_____________';
        const familyMemberCnic = document.getElementById('family_member_cnic').value || '_____________';
        const familyMemberRelation = document.getElementById('family_member_relation').value || '_____________';

        // Update the family member details
        nameText.textContent = familyMemberName;
        cnicText.textContent = familyMemberCnic;
        relationText.textContent = familyMemberRelation;

        // Keep the employee fields as placeholders
        employeeNameText.textContent = '_____________';
        employeeGradeText.textContent = '_____________';
        employeeSapIdText.textContent = '_____________';
    }

    // Add event listeners for family member details updates
    document.getElementById('family_member_name').addEventListener('input', updateFamilyApprovalText);
    document.getElementById('family_member_cnic').addEventListener('input', updateFamilyApprovalText);
    document.getElementById('family_member_relation').addEventListener('change', updateFamilyApprovalText);

    // Function to update the purpose and hospital spans
function updateSpans() {
    const purposeTextElement = document.getElementById('purpose_text');
    const hospitalTextElement = document.getElementById('hospital_text');

    // Check which section is visible (Self or Family)
    const selfDetails = document.getElementById('self_details');
    const familyDetails = document.getElementById('family_details');

    if (!selfDetails.classList.contains('hidden')) {
        // Self section is visible
        const selfPurpose = document.getElementById('self_purpose').value.trim();
        const selfHospital = document.getElementById('self_hospital').value.trim();
        purposeTextElement.textContent = selfPurpose || "_____________";
        hospitalTextElement.textContent = selfHospital || "_____________";
    } else if (!familyDetails.classList.contains('hidden')) {
        // Family section is visible
        const familyPurpose = document.getElementById('family_purpose').value.trim();
        const familyHospital = document.getElementById('family_hospital').value.trim();
        purposeTextElement.textContent = familyPurpose || "_____________";
        hospitalTextElement.textContent = familyHospital || "_____________";
    } else {
        // Neither section is visible (fallback)
        purposeTextElement.textContent = "_____________";
        hospitalTextElement.textContent = "_____________";
    }
}

// Add event listeners to Self fields
document.getElementById('self_purpose').addEventListener('input', updateSpans);
document.getElementById('self_hospital').addEventListener('change', updateSpans);

// Add event listeners to Family fields
document.getElementById('family_purpose').addEventListener('input', updateSpans);
document.getElementById('family_hospital').addEventListener('change', updateSpans);

// Add event listener to toggle between Self and Family sections
document.getElementById('category_type_option').addEventListener('change', function() {
    const selfDetails = document.getElementById('self_details');
    const familyDetails = document.getElementById('family_details');

    if (this.value === "Self") {
        selfDetails.classList.remove('hidden');
        familyDetails.classList.add('hidden');
    } else if (this.value === "Family/Dependents") {
        familyDetails.classList.remove('hidden');
        selfDetails.classList.add('hidden');
    } else {
        selfDetails.classList.add('hidden');
        familyDetails.classList.add('hidden');
    }

    // Update the spans when the section changes
    updateSpans();
    });

    // Family details
    function updateFamilyMemberDetails() {
        const categoryType = document.getElementById('category_type_option').value;
        const familyMemberSpan = document.getElementById('family_member');
    
        if (categoryType === "Self") {
            familyMemberSpan.classList.add('hidden');
            return; // Stop execution if "Self" is selected
        } else {
            familyMemberSpan.classList.remove('hidden');
        }
    
        const name = document.getElementById('family_member_name').value.trim();
        const cnic = document.getElementById('family_member_cnic').value.trim();
        const relation = document.getElementById('family_member_relation').value;
        
        // Determine salutation based on relationship
        let salutation = "";
        if (relation === "Wife of") {
            salutation = "MRS";
        } else if (relation === "Mother of") {
            salutation = "MRS";
        } else if (relation === "Daughter of") {
            salutation = "Ms";
        } else if (relation === "Father of" || relation === "Son of" || relation === "Husband of") {
            salutation = "MR";
        }
    
        // Format with appropriate salutation
        const formattedText = name && cnic && relation 
            ? `${salutation} ${name}, CNIC NO: ${cnic}, (${relation})` 
            : ""; 
    
        familyMemberSpan.textContent = formattedText;
    }
    
    // Attach event listeners to update span when any input changes
    document.getElementById('family_member_name').addEventListener('input', updateFamilyMemberDetails);
    document.getElementById('family_member_cnic').addEventListener('input', updateFamilyMemberDetails);
    document.getElementById('family_member_relation').addEventListener('change', updateFamilyMemberDetails);
    document.getElementById('category_type_option').addEventListener('change', updateFamilyMemberDetails);
    
    


    // Employee data fetch (Ajax Request)
    document.querySelectorAll('.fetch-employee-btn').forEach(button => {
        button.addEventListener('click', function() {
            const inputField = this.previousElementSibling;  // Get the related input field
            let sapId = inputField.value.trim();
            
            // If using the top SAP ID field, update all other SAP ID fields
            if (inputField.id === 'employee_sap_id') {
                // Update the SAP ID fields in both self and family sections
                if (document.getElementById('self_absence_employee')) {
                    document.getElementById('self_absence_employee').value = sapId;
                }
                if (document.getElementById('family_absence_employee')) {
                    document.getElementById('family_absence_employee').value = sapId;
                }
            } else {
                // If using section-specific SAP ID fields, update the top field
                document.getElementById('employee_sap_id').value = sapId;
            }
            
            // Get the updated SAP ID (in case it was changed)
            sapId = document.getElementById('employee_sap_id').value.trim();

            if (!sapId) {
                showErrorToast("Please enter an SAP ID before fetching data.");
                return;
            }

            fetch(`/get_employee/?sap_id=${sapId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.employee_name && data.designation) {
                        // Determine appropriate salutation based on gender for self
                        let salutation = data.employee_salutation;
                        const categoryType = document.getElementById('category_type_option').value;
                        
                        if (categoryType === "Self") {
                            // For self, use gender-appropriate salutation
                            if (data.employee_cnic) {
                                const lastDigit = data.employee_cnic.slice(-1);
                                if (parseInt(lastDigit) % 2 === 0){

                                    salutation = "Ms.";
                                }
                                else if (parseInt(lastDigit) % 2 !== 0) {
                                    salutation = "Mr.";
                                }
                            } 
                        }
                        
                        // Update employee details in approval header
                        document.getElementById('employee_name').textContent = salutation + " " + data.employee_name;
                        document.getElementById('employee_sapID').textContent = sapId;
                        document.getElementById('employee_grade').textContent = data.employee_grade;
                        document.getElementById('employee_cnic').textContent = data.employee_cnic;

                        // Update employee details in family approval text
                        document.getElementById('employee_name_relation').textContent = salutation + " " + data.employee_name;
                        document.getElementById('employee_sapid_relation').textContent = sapId;
                        document.getElementById('employee_grade_relation').textContent = data.employee_grade;

                        let formattedSalutation = (salutation === "MR") ? "Mr" : salutation;
                        // Update employee details in medical bill text
                        document.getElementById('employee_name_text').textContent = formattedSalutation  + " " + data.employee_name;
                        document.getElementById('employee_sapID_text').textContent = sapId;
                        document.getElementById('employee_grade_text').textContent = data.employee_grade;
                        
                        // Update SAP ID in the letter header
                        document.getElementById('letter_header_sapid').textContent = sapId;
                        
                        // Update relationship dropdown based on employee type
                        updateRelationshipDropdown(data.employee_type);

                        showSuccessToast("Employee found!");
                    } else {
                        resetPlaceholders();
                    }
                })
                .catch(error => {
                    showErrorToast("Employee with this SAP ID not found!");
                });
        });
    });

    // Reset placeholders when no employee is found
    function resetPlaceholders() {
        // Reset employee details in approval header
        document.getElementById('employee_name').textContent = "_____________";
        document.getElementById('employee_sapID').textContent = "_____________";
        document.getElementById('employee_grade').textContent = "_____________";
        document.getElementById('employee_cnic').textContent = "_____________";

        // Reset employee details in family approval text
        document.getElementById('employee_name_relation').textContent = "_____________";
        document.getElementById('employee_sapid_relation').textContent = "_____________";
        document.getElementById('employee_grade_relation').textContent = "_____________";
        
        // Reset SAP ID in the letter header
        document.getElementById('letter_header_sapid').textContent = "_____________";
        
        // Reset relationship dropdown to default state
        const relationshipDropdown = document.getElementById('family_member_relation');
        // Clear existing options except the first one
        while (relationshipDropdown.options.length > 1) {
            relationshipDropdown.remove(1);
        }
        // Add a default "Not Allowed" option
        const optionElement = document.createElement("option");
        optionElement.value = "";
        optionElement.text = "Not Allowed";
        relationshipDropdown.add(optionElement);

        showErrorToast("Employee with this SAP ID not found!");
    }

    // Show Error Toast
    function showErrorToast(message) {
        const toast = document.getElementById('errorToast');
        toast.textContent = message;
        toast.classList.remove('hidden', 'opacity-0');
        toast.classList.add('opacity-100');

        setTimeout(() => {
            toast.classList.add('hidden');
        }, 3000);
    }

    // Show Success Toast
    function showSuccessToast(message) {
        const toast = document.getElementById('successToast');
        toast.textContent = message;
        toast.classList.remove('hidden', 'opacity-0');
        toast.classList.add('opacity-100');

        setTimeout(() => {
            toast.classList.add('hidden');
        }, 3000);
    }
    
    // Update relationship dropdown based on employee type
    function updateRelationshipDropdown(employeeType) {
        const relationshipDropdown = document.getElementById('family_member_relation');
        
        // Clear existing options except the first one
        while (relationshipDropdown.options.length > 1) {
            relationshipDropdown.remove(1);
        }
        
        // Add options based on employee type
        if (employeeType === "Regular") {
            const regularOptions = [
                { value: "Father of", text: "Father of" },
                { value: "Mother of", text: "Mother of" },
                { value: "Son of", text: "Son of" },
                { value: "Daughter of", text: "Daughter of" },
                { value: "Wife of", text: "Wife of" },
                { value: "Husband of", text: "Husband of" }
            ];
            
            regularOptions.forEach(option => {
                const optionElement = document.createElement("option");
                optionElement.value = option.value;
                optionElement.text = option.text;
                relationshipDropdown.add(optionElement);
            });
        } else if (employeeType === "Contractual") {
            const contractualOptions = [
                { value: "Son of", text: "Son of" },
                { value: "Daughter of", text: "Daughter of" },
                { value: "Wife of", text: "Wife of" },
                { value: "Husband of", text: "Husband of" }
            ];
            
            contractualOptions.forEach(option => {
                const optionElement = document.createElement("option");
                optionElement.value = option.value;
                optionElement.text = option.text;
                relationshipDropdown.add(optionElement);
            });
        } else {
            // For other employee types, add a "Not Allowed" option
            const optionElement = document.createElement("option");
            optionElement.value = "";
            optionElement.text = "Not Allowed";
            relationshipDropdown.add(optionElement);
        }
    }

    // Show/hide sections based on category selection
    document.getElementById('category_type_option').addEventListener('change', function() {
        const familyDetails = document.getElementById('family_details');
        const selfDetails = document.getElementById('self_details');
        const doctorsAdviceText = document.getElementById('doctors_advice_text');
        const medicalBillText = document.getElementById('medical_bill_text');
        const familyApprovalText = document.getElementById('family_approval_text');
        const approvalType = document.getElementById('approval_type_option').value;

        if (this.value === "Family/Dependents") {
            familyDetails.classList.remove('hidden');
            selfDetails.classList.add('hidden');
            doctorsAdviceText.style.display = 'block';
            medicalBillText.style.display = 'none';
            if (approvalType === "Post Facto Approval") {
                familyApprovalText.style.display = 'block';
            } else {
                familyApprovalText.style.display = 'none';
            }
        } else if (this.value === "Self") {
            selfDetails.classList.remove('hidden');
            familyDetails.classList.add('hidden');
            familyApprovalText.style.display = 'none';
            if (approvalType === "Post Facto Approval") {
                doctorsAdviceText.style.display = 'none';
                medicalBillText.style.display = 'block';
            } else {
                doctorsAdviceText.style.display = 'block';
                medicalBillText.style.display = 'none';
            }
        } else {
            selfDetails.classList.add('hidden');
            familyDetails.classList.add('hidden');
            doctorsAdviceText.style.display = 'block';
            medicalBillText.style.display = 'none';
            familyApprovalText.style.display = 'none';
        }
        
        // Trigger employee data refresh to update salutation if employee data is already loaded
        const sapId = document.getElementById('employee_sap_id').value.trim();
        if (sapId) {
            // Get the fetch button associated with the top SAP ID field
            const fetchButton = document.querySelector('#employee_sap_id').nextElementSibling;
            if (fetchButton) {
                fetchButton.click();
            }
        }
    });


// Max disgits
document.getElementById('family_member_cnic').addEventListener('input', function (e) {
    this.value = this.value.replace(/\D/g, '').slice(0, 13); // Allow only numbers & max 13 characters
});


// Show/hide Hospital Advice Date field and text paragraphs based on selected approval type and category
document.getElementById('approval_type_option').addEventListener('change', function() {
    const hospitalAdviceDateField = document.getElementById('hospital_advice_date');
    const doctorsAdviceText = document.getElementById('doctors_advice_text');
    const medicalBillText = document.getElementById('medical_bill_text');
    const familyApprovalText = document.getElementById('family_approval_text');
    const categoryType = document.getElementById('category_type_option').value;
    const employeeNameText = document.getElementById('employee_name_text');
    const employeeGradeText = document.getElementById('employee_grade_text');
    const employeeSapIDText = document.getElementById('employee_sapID_text');
    const employeeName = document.getElementById('employee_name').textContent;
    const employeeGrade = document.getElementById('employee_grade').textContent;
    const employeeSapID = document.getElementById('employee_sapID').textContent;

    // Show Hospital Advice Date field for both approval types
    if (this.value === "Post Facto Approval" || this.value === "Approval/Permission") {
        hospitalAdviceDateField.classList.remove('hidden');
        doctorsAdviceText.innerHTML = 'Enclosed please find a self-explanatory Doctor\'s advice dated <span id="hospital_advice_date_text">_____________</span> on the captioned subject.';
    } else {
        hospitalAdviceDateField.classList.add('hidden');
    }
    
    // Handle specific display logic based on approval type and category
    if (this.value === "Post Facto Approval" && categoryType === "Self") {
        doctorsAdviceText.style.display = 'none';
        medicalBillText.style.display = 'block';
        familyApprovalText.style.display = 'none';
        employeeNameText.textContent = employeeName;
        employeeGradeText.textContent = employeeGrade;
        employeeSapIDText.textContent = employeeSapID;
    } else if (this.value === "Post Facto Approval" && categoryType === "Family/Dependents") {
        doctorsAdviceText.style.display = 'block';
        medicalBillText.style.display = 'none';
        familyApprovalText.style.display = 'block';
    } else if (this.value === "Approval/Permission") {
        doctorsAdviceText.style.display = 'block';
        medicalBillText.style.display = 'none';
        
        if (categoryType === "Family/Dependents") {
            familyApprovalText.style.display = 'block';
        } else {
            familyApprovalText.style.display = 'none';
        }
    } else {
        doctorsAdviceText.style.display = 'block';
        medicalBillText.style.display = 'none';
        familyApprovalText.style.display = 'none';
    }
});


// Update the span with the selected Hospital Advice Date in "Month Day, Year" format
document.getElementById('hospital_advice_date_input').addEventListener('change', function() {
    const hospitalAdviceDateText = document.getElementById('hospital_advice_date_text');

    // Get the selected date value
    const selectedDate = this.value;

    if (selectedDate) {
        // Convert the date string to a Date object
        const date = new Date(selectedDate);

        // Format the date as "Month Day, Year"
        const formattedDate = date.toLocaleDateString('en-US', {
            year: 'numeric',
            month: 'long',
            day: 'numeric'
        });

        // Update the span with the formatted date
        hospitalAdviceDateText.textContent = formattedDate;
    } else {
        // If no date is selected, display the fallback text
        hospitalAdviceDateText.textContent = "_____________";
    }
});


// Update employee signature details
// Update employee signature details
$(document).ready(function() {
    $('#form_type').on('change', function() {
        var sapId = $(this).val();
        if (sapId) {
            $.ajax({
                url: "{% url 'reporting:get_employee_data' %}", 
                data: {
                    'sap_id': sapId
                },
                dataType: 'json',
                success: function(data) {

                    // Update the employee details section with retrieved data
                    $('#employee-details').html(`
                        <p>_________________________</p>
                        <p class="font-semibold">${data.employee_name}</p>
                        <p class="text-sm">${data.grade}/${data.designation}</p>
                        <p class="text-sm">${data.wing} ${data.division} (${data.group})</p>
                    `);
                },
                error: function() {
                    $('#employee-details').html('<p class="text-red-500">Error loading data.</p>');
                }
            });
        } else {
            $('#employee-details').empty();
        }
    });
});

// Add event listener to family_member_relation dropdown to auto-populate family member details
document.getElementById('family_member_relation').addEventListener('change', function() {
    const relation = this.value;
    // Always use the top-level SAP ID field
    const sapId = document.getElementById('employee_sap_id').value.trim();
    const statusElement = document.getElementById('family_member_status');
    
    // Clear status message
    statusElement.textContent = '';
    statusElement.className = 'ml-2 text-sm';
    
    if (relation && sapId) {
        // First, try to fetch existing family member data
        fetch(`/get_family_member/?sap_id=${sapId}&relation=${encodeURIComponent(relation)}`)
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.exists) {
                        console.log('Family member data:', data);
                        // Family member exists, populate the fields with actual data
                        document.getElementById('family_member_name').value = data.name;
                        document.getElementById('family_member_cnic').value = data.cnic;
                        
                        // Update the display text
                        updateFamilyMemberDetails();
                        updateFamilyApprovalText();
                        
                        // Show status message
                        statusElement.textContent = 'Family member data loaded';
                        statusElement.className = 'ml-2 text-sm text-green-600';
                    } else {
                        // Family member doesn't exist, generate placeholder data
                        fetch(`/get_employee/?sap_id=${sapId}`)
                            .then(response => response.json())
                            .then(employeeData => {
                                if (employeeData.employee_name) {
                                    // Auto-populate family member name field based on relation
                                    let familyMemberName = '';
                                    if (relation === 'Father of') {
                                        familyMemberName = employeeData.employee_salutation === 'MR.' ? 'Mr. ' + employeeData.employee_name.split(' ')[0] + '\'s Father' : '';
                                    } else if (relation === 'Mother of') {
                                        familyMemberName = employeeData.employee_salutation === 'MR.' ? 'Mrs. ' + employeeData.employee_name.split(' ')[0] + '\'s Mother' : '';
                                    } else if (relation === 'Son of') {
                                        familyMemberName = 'Son of ' + employeeData.employee_salutation + ' ' + employeeData.employee_name;
                                    } else if (relation === 'Daughter of') {
                                        familyMemberName = 'Daughter of ' + employeeData.employee_salutation + ' ' + employeeData.employee_name;
                                    } else if (relation === 'Wife of') {
                                        familyMemberName = 'Mrs. ' + employeeData.employee_name.split(' ')[0];
                                    } else if (relation === 'Husband of') {
                                        familyMemberName = 'Mr. ' + employeeData.employee_name.split(' ')[0];
                                    }
                                    
                                    // Set the family member name if we generated one
                                    if (familyMemberName) {
                                        document.getElementById('family_member_name').value = familyMemberName;
                                    }
                                    
                                    // Clear other fields for new entry
                                    document.getElementById('family_member_cnic').value = '';
                                    
                                    // Update the display text
                                    updateFamilyMemberDetails();
                                    updateFamilyApprovalText();
                                    
                                    // Show status message
                                    statusElement.textContent = 'No saved data found. Please enter details and save.';
                                    statusElement.className = 'ml-2 text-sm text-yellow-600';
                                }
                            })
                            .catch(error => {
                                showErrorToast('Failed to generate family member details.');
                            });
                    }
                } else {
                    showErrorToast('Failed to fetch family member data: ' + data.error);
                }
            })
            .catch(error => {
                showErrorToast('Failed to fetch family member data.');
            });
    }
});

// Add event listener for the save family member button
document.getElementById('save_family_member').addEventListener('click', function() {
    // Always use the top-level SAP ID field
    const sapId = document.getElementById('employee_sap_id').value.trim();
    const relation = document.getElementById('family_member_relation').value;
    const name = document.getElementById('family_member_name').value.trim();
    const cnic = document.getElementById('family_member_cnic').value.trim();
    const statusElement = document.getElementById('family_member_status');
    
    // Validate inputs - only SAP ID, Relationship, Name, and CNIC are required
    if (!sapId || !relation || !name || !cnic) {
        showErrorToast('Please fill in all required fields (SAP ID, Relationship, Name, CNIC)');
        return;
    }
    
    // Validate CNIC format (13 digits)
    if (!/^\d{13}$/.test(cnic)) {
        showErrorToast('CNIC must be exactly 13 digits');
        return;
    }
    
    // Save the family member data
    fetch('/save_family_member/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            sap_id: sapId,
            relation: relation,
            name: name,
            cnic: cnic
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showSuccessToast('Family member details saved successfully!');
            statusElement.textContent = 'Family member data saved';
            statusElement.className = 'ml-2 text-sm text-green-600';
            
            // Update the display text
            updateFamilyMemberDetails();
            updateFamilyApprovalText();
        } else {
            showErrorToast('Failed to save family member details: ' + data.error);
            statusElement.textContent = 'Failed to save';
            statusElement.className = 'ml-2 text-sm text-red-600';
        }
    })
    .catch(error => {
        showErrorToast('Failed to save family member details.');
        statusElement.textContent = 'Failed to save';
        statusElement.className = 'ml-2 text-sm text-red-600';
    });
});

</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.js"></script>

<!-- Modal and Form Handling Scripts -->
<script>
    // Purpose Modal Functionality
    document.getElementById('add_purpose_btn').addEventListener('click', function() {
        document.getElementById('purposeModal').classList.remove('hidden');
    });
    
    document.getElementById('add_family_purpose_btn').addEventListener('click', function() {
        document.getElementById('purposeModal').classList.remove('hidden');
    });
    
    // Hospital Modal Functionality
    document.getElementById('add_hospital_btn').addEventListener('click', function() {
        document.getElementById('hospitalModal').classList.remove('hidden');
    });
    
    document.getElementById('add_family_hospital_btn').addEventListener('click', function() {
        document.getElementById('hospitalModal').classList.remove('hidden');
    });
    
    // Close Modal Functionality
    document.querySelectorAll('.close-modal').forEach(button => {
        button.addEventListener('click', function() {
            document.getElementById('purposeModal').classList.add('hidden');
            document.getElementById('hospitalModal').classList.add('hidden');
        });
    });
    
    // Save New Purpose
    document.getElementById('save_purpose_btn').addEventListener('click', function() {
        const purposeName = document.getElementById('new_purpose_name').value.trim();
        
        if (!purposeName) {
            showErrorToast('Please enter a purpose name');
            return;
        }
        
        // Send data to server
        fetch('/save_purpose/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                purpose_name: purposeName
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Add new option to both purpose dropdowns
                const selfPurpose = document.getElementById('self_purpose');
                const familyPurpose = document.getElementById('family_purpose');
                
                const newOption = document.createElement('option');
                newOption.value = purposeName;
                newOption.text = purposeName;
                
                selfPurpose.appendChild(newOption.cloneNode(true));
                familyPurpose.appendChild(newOption);
                
                // Select the new option in both dropdowns
                selfPurpose.value = purposeName;
                familyPurpose.value = purposeName;
                
                // Update the purpose text in the letter
                document.getElementById('purpose_text').textContent = purposeName;
                
                // Clear the input field
                document.getElementById('new_purpose_name').value = '';
                
                // Close the modal
                document.getElementById('purposeModal').classList.add('hidden');
                
                showSuccessToast('Purpose added successfully!');
            } else {
                showErrorToast(data.error || 'Failed to add purpose');
            }
        })
        .catch(error => {
            showErrorToast('An error occurred while saving the purpose');
            console.error('Error:', error);
        });
    });
    
    // Save New Hospital
    document.getElementById('save_hospital_btn').addEventListener('click', function() {
        const hospitalName = document.getElementById('new_hospital_name').value.trim();
        
        if (!hospitalName) {
            showErrorToast('Please enter a hospital name');
            return;
        }
        
        // Send data to server
        fetch('/save_hospital/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                hospital_name: hospitalName
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Add new option to both hospital dropdowns
                const selfHospital = document.getElementById('self_hospital');
                const familyHospital = document.getElementById('family_hospital');
                
                const newOption = document.createElement('option');
                newOption.value = hospitalName;
                newOption.text = hospitalName;
                
                selfHospital.appendChild(newOption.cloneNode(true));
                familyHospital.appendChild(newOption);
                
                // Select the new option in both dropdowns
                selfHospital.value = hospitalName;
                familyHospital.value = hospitalName;
                
                // Update the hospital text in the letter
                document.getElementById('hospital_text').textContent = hospitalName;
                
                // Clear the input field
                document.getElementById('new_hospital_name').value = '';
                
                // Close the modal
                document.getElementById('hospitalModal').classList.add('hidden');
                
                showSuccessToast('Hospital added successfully!');
            } else {
                showErrorToast(data.error || 'Failed to add hospital');
            }
        })
        .catch(error => {
            showErrorToast('An error occurred while saving the hospital');
            console.error('Error:', error);
        });
    });
    
    // Helper function to get CSRF token from cookies
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
</script>
{% endblock content %}

{% extends "sidebar.html" %}
{% load static %}
{% load custom_filters %}

{% block content %}
<body class="p-8 bg-gray-100">
    <!-- Main Container with Two-Column Layout -->
    <div class="flex flex-col lg:flex-row gap-6 max-w-screen-xl mx-auto">
        <!-- Left Column - Application Form -->
        <div class="w-full lg:w-5/12 p-6 bg-white shadow-lg rounded-lg my-4">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Application Form</h2>
            
            <!-- Employee SAP ID Search Field -->
            <div class="mb-6">
                <label for="search_sap_id" class="block text-sm font-medium text-gray-700 mb-2">Employee SAP ID:</label>
                <div class="flex space-x-2 w-10/12">
                    <input type="number" id="search_sap_id" class="p-2 flex-1 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm" placeholder="Enter SAP ID">
                    <button type="button" id="search_employee" class="px-4 py-2 bg-blue-500 text-white font-semibold rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                        Search
                    </button>
                </div>
            </div>
            
            <!-- Employee Leave Balance Section -->
            <div id="leave-balance-section" class="mb-6 hidden">
                <h3 class="text-lg font-semibold text-gray-800 mb-2">Leave Balances</h3>
                <div id="leave-balances" class="space-y-2">
                    <!-- Leave balances will be populated here -->
                </div>
            </div>
            
            <!-- Leave Application Form -->
            <form action="{% if employee and employee.SAP_ID %}{% url 'reporting:application_leave' employee.SAP_ID %}{% else %}#{% endif %}" method="post" enctype="multipart/form-data" id="leave-application-form">
                {% csrf_token %}
                <!-- Input Fields for User Data -->
                <div class="space-y-4">
                    <div>
                        <label for="application_date" class="block text-sm font-medium text-gray-700">Application Date:</label>
                        <input type="date" id="application_date" name="application_date" class="mt-1 p-2 w-10/12 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm" required>
                    </div>

                    <div>
                        <label for="granted_leaves" class="block text-sm font-medium text-gray-700">Granted Leaves:</label>
                        <input type="number" id="granted_leaves" name="granted_leaves" class="mt-1 p-2 w-10/12 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm" required placeholder="e.g. 20 days">
                    </div>

                    <div>
                        <label for="effect_from" class="block text-sm font-medium text-gray-700">Effective From:</label>
                        <input type="date" id="effect_from" name="effect_from" class="mt-1 p-2 w-10/12 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm" required>
                    </div>

                    <div>
                        <label for="effect_to" class="block text-sm font-medium text-gray-700">Effective To:</label>
                        <input type="date" id="effect_to" name="effect_to" class="mt-1 p-2 w-10/12 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm" required>
                    </div>

                    <div>
                        <label for="purpose" class="block text-sm font-medium text-gray-700">Purpose/Reason:</label>
                        <textarea id="purpose" name="purpose" class="mt-1 p-2 w-10/12 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm" required rows="3" placeholder="Enter the purpose of leave"></textarea>
                    </div>

                    <div>
                        <label for="leave_type_option" class="block text-sm font-medium text-gray-700">Leave Type:</label>
                        <select id="leave_type_option" name="leave_type_option" class="mt-1 p-2 w-10/12 border border-blue-500 rounded-md focus:outline-none focus:border-blue-700 transition-colors duration-300 shadow-sm text-sm" required>
                            <option value="">Select Leave Type</option>
                            {% for leave_type in leave_types %}
                                <option value="{{ leave_type.id }}" data-code="{{ leave_type.code }}">{{ leave_type.name }}</option>
                            {% endfor %}
                        </select>
                        <div class="mt-1 text-xs text-gray-500">
                            <span id="leave_balance_display">Available balance: <span class="font-semibold">--</span></span>
                        </div>
                    </div>

                    <div id="extension_policy_section">
                        <p class="text-sm font-medium text-gray-700">Leave Extension Policy:</p>
                        <div class="flex items-center space-x-6 mt-2">
                            <label class="flex items-center space-x-2">
                                <input type="radio" name="extension" value="allowed" class="focus:ring-2 focus:ring-blue-500">
                                <span>Allowed</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="radio" name="extension" value="not_allowed" class="focus:ring-2 focus:ring-blue-500" checked>
                                <span>Not Allowed</span>
                            </label>
                        </div>
                    </div>
                    
                    <div id="station_permission_section" style="display: none;">
                        <p class="text-sm font-medium text-gray-700">With permission to leave the station?</p>
                        <div class="flex items-center space-x-6 mt-2">
                            <label class="flex items-center space-x-2">
                                <input type="radio" name="station_permission" value="yes" class="focus:ring-2 focus:ring-blue-500">
                                <span>Yes</span>
                            </label>
                            <label class="flex items-center space-x-2">
                                <input type="radio" name="station_permission" value="no" class="focus:ring-2 focus:ring-blue-500" checked>
                                <span>No</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <label for="absence_employee" class="block text-sm font-medium text-gray-700">Employee Back-up SAP ID 1:</label>
                        <div class="flex space-x-2 w-10/12">
                            <input value="" type="number" id="absence_employee" class="p-2 flex-1 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm" placeholder="e.g. 83787">
                            <button type="button" id="fetch_employee_data" class="px-2 py-1 bg-blue-500 text-white font-semibold rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                Fetch
                            </button>
                        </div>
                    </div>

                    <div>
                        <label for="absence_employee2" class="block text-sm font-medium text-gray-700">Employee Back-up SAP ID 2:</label>
                        <div class="flex space-x-2 w-10/12">
                            <input value="" type="number" id="absence_employee2" class="p-2 flex-1 border border-gray-300 rounded-md focus:ring-2 focus:ring-blue-500 focus:outline-none text-sm" placeholder="e.g. 83787">
                            <button type="button" id="fetch_employee_data2" class="px-2 py-1 bg-blue-500 text-white font-semibold rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                                Fetch
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 text-center">
                    <button type="submit" class="px-4 py-2 bg-blue-500 text-white font-semibold rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                        Submit Application
                    </button>
                </div>
            </form>

            <!-- Admin Signature Selection -->
            <div class="mt-4">
                <label for="form_type" class="block text-sm font-medium text-gray-700">Admin Signature:</label>
                <select id="form_type" name="form_type" class="p-2 w-10/12 border border-blue-500 rounded-md focus:outline-none focus:border-blue-700 transition-colors duration-300 shadow-sm text-sm">
                    <option value="">Select Admin Signature</option>
                    {% for employee in admin_signuture %}
                        <option value="{{ employee.SAP_ID }}">{{ employee.employee_name }} ({{ employee.SAP_ID }})</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Action Buttons -->
            <div class="mt-6 flex justify-center space-x-4">
                <button type="button" id="download" class="bg-blue-500 text-white px-4 py-1.5 rounded-md shadow-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-300 text-sm font-medium transition-colors duration-300">
                    <span class="flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        Download as PDF
                    </span>
                </button>
                <button type="button" id="save_to_cloudinary" class="bg-green-500 text-white px-4 py-1.5 rounded-md shadow-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-300 text-sm font-medium transition-colors duration-300">
                    <span class="flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                        </svg>
                        Save
                    </span>
                </button>
            </div>

            <!-- Error Toast -->
            <div id="errorToast" class="fixed bottom-5 right-5 hidden bg-red-500 text-white text-base px-6 py-3 rounded-xl shadow-lg transition-opacity duration-300">
                Employee with this SAP ID not found!
            </div>

            <!-- Success Toast -->
            <div id="sucessToast" class="fixed bottom-5 right-5 hidden bg-green-500 text-white text-base px-6 py-3 rounded-xl shadow-lg transition-opacity duration-300">
                Employee found!
            </div>
            
            <!-- Leave Balance Warning Toast -->
            <div id="balanceWarningToast" class="fixed bottom-5 right-5 hidden bg-yellow-500 text-white text-base px-6 py-3 rounded-xl shadow-lg transition-opacity duration-300">
                Insufficient leave balance for selected leave type!
            </div>
        </div>

        <!-- Right Column - Dynamic Letter Preview -->
        <div class="w-full lg:w-7/12 bg-white shadow-lg rounded-lg my-4 overflow-auto">
            <div id="download_letter" class="p-10" style="position: relative; min-height: 1123px; display: flex; flex-direction: column; page-break-inside: avoid;">
        <!-- Header Section -->
        <div class="mb-4">
            <div class="flex justify-between items-center">
                <div>
                    <img src="{% static 'reporting/images/NBP.png' %}" alt="NBP Logo" class="h-21">
                </div>
                <div class="text-right mt-9">
                    <p class="font-semibold pr-6">Operations Group</p>
                </div>
            </div>
            <!-- Full-width border under the header section -->
            <hr class="border-t border-gray-400">
            <div class="text-sm mt-2 flex justify-between items-center">
                <p class="font-semibold">National Bank of Pakistan</p>
                <p class="font-semibold pr-3">Administration Division</p>
            </div>
            <div class="text-sm mt-3 mb-12">
                <p>No. OPG/<span id="leave_type_text"></span>ADMN/{{employee.SAP_ID}}/{{current_time |date:"Y" }}/</p>
                <p class="font-semibold">{{current_time |date:"F j, Y" }}</p>  
            </div>
        </div>

        <!-- Title -->
        <u><h1 class="text-center text-xl font-bold mb-5">MEMORANDUM</h1></u>

        <!-- Body Text -->
        <p class="mb-4" style="text-align: justify;">
            With reference to his application dated <b><span id="application_date_text">______________</span></b> <span class="employee-salutation">{{employee.employee_salutation | capitalize_words }}</span> <span class="employee-name">{{employee.name}}</span>, <span class="employee-grade">{{employee.employee_grade}}</span>/<span class="employee-type">{{employee.employee_type}}</span> SAP ID: <span class="employee-sapid">{{employee.SAP_ID}}</span>, 
            NBP, Regional Office, <span class="employee-region">{{employee.region}}</span> is advised that he has been granted <span id="granted_leaves_text">______________</span> <span id="leave_type_text">______________</span> leave effective from <span id="effect_from_text">______________</span> to <span id="effect_to_text">______________</span>.
        </p>
        <p class="mb-4" style="text-align: justify;">
            <strong>Purpose/Reason:</strong> <span id="purpose_text">______________</span>
        </p>
        <p class="mb-4" style="text-align: justify;">
            <span class="employee-salutation">{{employee.employee_salutation | capitalize_words }}</span> <span class="employee-name">{{employee.name}}</span> will accordingly stand relieved to his duties as of close of office today i.e. <b>{{current_time | date:"F j, Y" }}</b> to avail sanctioned leave(s). <span id="extension_text"></span> {% if is_friday == True %}Accordingly <span class="employee-salutation">{{employee.employee_salutation | capitalize_words }}</span> <span class="employee-name">{{employee.name}}</span> is hereby relieved of his duties by the close of office hours today i.e.
            Friday, {{current_time | date:"F j, Y"}}. ({{next_day | date:"F, Y"}} & {{next_next_day | date:"F, Y"}} i.e. Saturday and Sunday being public holidays){% endif %}
        </p>


        <p id="during_absence" class="mb-4" style="text-align: justify;">
            During his/her absence, <span id="employee_backup_name">_____________</span>, <span id="employee_backup_designation">_____________</span>, SAP ID: <span id="employee_backup_sapID">_____________</span> 
            <span id="second_backup_section">and <span id="employee_backup_name2">_____________</span>, <span id="employee_backup_designation2">_____________</span>, SAP ID: <span id="employee_backup_sapID2">_____________</span></span>, will look after his assignment.
        </p>
        

        
        {% comment %} <div class="mt-10 text-right mb-4">
            <select id="form_type" name="form_type" class="w-1/4 bg-white border border-blue-500 py-2 px-4 rounded-lg focus:outline-none focus:border-blue-700 transition-colors duration-300 shadow-md">
                <option value="">Admin Signature</option>
                {% for employee in admin_signuture %}
                    <option value="{{ employee.SAP_ID }}">{{ employee.employee_name }} ({{ employee.SAP_ID }})</option>
                {% endfor %}
            </select>
        </div> {% endcomment %}
        

        <!-- Signature Section -->
        <div id="employee-details" class="mb-1 text-right mt-10">
            <!-- Data will be inserted here dynamically-->
        </div>
    

        <!-- Recipient Information Section -->
        <div class="mt-8" id="recipient-information-section">
            {% if employee and employee.SAP_ID %}
                <p class="font-semibold">{{employee.employee_salutation | capitalize_words}} {{employee.name}}</p>
                <p class="text-sm">{{employee.employee_grade}}/ {{employee.employee_type}}</p>
                <p class="text-sm">SAP ID: {{employee.SAP_ID}}</p>
            {% else %}
                <p class="font-semibold recipient-name">______________</p>
                <p class="text-sm recipient-grade-type">______________</p>
                <p class="text-sm recipient-sapid">SAP ID: ______________</p>
            {% endif %}
        </div>

        <!-- Footer Section -->
        <div style="position: relative; margin-top: auto; left: 0; right: 0; width: 100%;" class="footer">
            <hr class="border-t border-gray-400 mb-2">
            <div class="text-center text-xs text-gray-600">
                <p class="font-semibold">National Bank of Pakistan</p>
                <p>Head Office: I.I. Chundrigar Road, Karachi. Ph: 9212100 (50 lines)</p>
                <p>Website: www.nbp.com.pk</p>
            </div>
        </div>
    </div>

            </div>
        </div>
    </div>
</body>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script>
    // Function to prepare the document for PDF generation
    function prepareDocumentForPDF() {
        const application_date_elem = document.getElementById('application_date');
        const granted_leaves_elem = document.getElementById('granted_leaves');
        const effect_from_elem = document.getElementById('effect_from');
        const effect_to_elem = document.getElementById('effect_to');
        const sapId_elem = document.getElementById('absence_employee');
        const sapId2_elem = document.getElementById('absence_employee2');
        
        // Safely get values, using empty string as fallback if element doesn't exist
        const application_date = application_date_elem ? application_date_elem.value : '';
        const granted_leaves = granted_leaves_elem ? granted_leaves_elem.value : '';
        const effect_from = effect_from_elem ? effect_from_elem.value : '';
        const effect_to = effect_to_elem ? effect_to_elem.value : '';
        const sapId = sapId_elem ? sapId_elem.value : '';
        const sapId2 = sapId2_elem ? sapId2_elem.value : '';
    
        const form = document.getElementById('form_type');
        form.style.visibility = 'hidden'; // Make the select element invisible but keep its position
    
        // Check if SAP ID is provided for the first backup employee
        const absenceParagraph = document.getElementById('during_absence');
        if (!sapId || sapId.trim() === '') {
            // Hide the entire paragraph if no SAP ID is provided for the first backup employee
            absenceParagraph.style.display = 'none';
        } else {
            absenceParagraph.style.display = 'block';
        }
    
        // Check if SAP ID is provided for the second backup employee
        const secondBackupSection = document.getElementById('second_backup_section');
        if (!sapId2 || sapId2.trim() === '') {
            // Hide the second backup section if no SAP ID is provided
            secondBackupSection.style.display = 'none';
        } else {
            secondBackupSection.style.display = 'inline';
        }
        
        // Only validate fields that exist and are required
        if (!(application_date && granted_leaves)) {
            // Show an alert if required fields are empty
            alert("Please fill out the required fields");
            return false;
        }
        
        // Get elements safely
        const applicationDateElement = document.getElementById('application_date_text');
        const grantedLeavesElement = document.getElementById('granted_leaves_text');
        const effectFromElement = document.getElementById('effect_from_text');
        const effectToElement = document.getElementById('effect_to_text');

        // Store original values (safely)
        const originalValues = {
            applicationDate: applicationDateElement ? applicationDateElement.textContent : '',
            grantedLeaves: grantedLeavesElement ? grantedLeavesElement.textContent : ''
        };
        
        // Add effect_from and effect_to to originalValues only if the elements exist
        if (effectFromElement) {
            originalValues.effectFrom = effectFromElement.textContent;
        }
        
        if (effectToElement) {
            originalValues.effectTo = effectToElement.textContent;
        }

        // Set formatted values for PDF (safely)
        if (applicationDateElement) {
            applicationDateElement.textContent = applicationDateElement.getAttribute('data-formatted-date') || originalValues.applicationDate;
        }
        
        if (grantedLeavesElement) {
            grantedLeavesElement.textContent = grantedLeavesElement.getAttribute('data-formatted-value') || originalValues.grantedLeaves;
        }
        
        if (effectFromElement) {
            effectFromElement.textContent = effectFromElement.getAttribute('data-formatted-date') || originalValues.effectFrom;
        }
        
        if (effectToElement) {
            effectToElement.textContent = effectToElement.getAttribute('data-formatted-date') || originalValues.effectTo;
        }
        return {
            element: document.getElementById('download_letter'),
            originalValues: originalValues,
            absenceParagraph: absenceParagraph,
            secondBackupSection: secondBackupSection
        };
    }
    
    // Function to restore document after PDF generation
    function restoreDocumentAfterPDF(docState) {
        if (!docState) return;
        
        const { originalValues, absenceParagraph, secondBackupSection } = docState;
        
        // After PDF is processed, restore original values and display (safely)
        const applicationDateElement = document.getElementById('application_date_text');
        const grantedLeavesElement = document.getElementById('granted_leaves_text');
        const effectFromElement = document.getElementById('effect_from_text');
        const effectToElement = document.getElementById('effect_to_text');
        const formElement = document.getElementById('form_type');
        
        // Safely restore original values
        if (applicationDateElement && originalValues.applicationDate !== undefined) {
            applicationDateElement.textContent = originalValues.applicationDate;
        }
        
        if (grantedLeavesElement && originalValues.grantedLeaves !== undefined) {
            grantedLeavesElement.textContent = originalValues.grantedLeaves;
        }
        
        if (effectFromElement && originalValues.effectFrom !== undefined) {
            effectFromElement.textContent = originalValues.effectFrom;
        }
        
        if (effectToElement && originalValues.effectTo !== undefined) {
            effectToElement.textContent = originalValues.effectTo;
        }
        
        // Restore display properties
        if (absenceParagraph) absenceParagraph.style.display = 'block';
        if (secondBackupSection) secondBackupSection.style.display = 'inline';
        if (formElement) formElement.style.visibility = 'visible';
    }
    
    // Download PDF button click handler
    document.getElementById('download').addEventListener('click', function() {
        const docState = prepareDocumentForPDF();
        if (!docState) return;
        
        // Options for generating PDF
        const options = {
            filename: '{{employee.name}}.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 }, // For high-quality rendering
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
            pagebreak: { mode: ['avoid-all', 'css', 'legacy'] },
            footer: { height: '28mm', contents: { } }
        };

        // Generate the PDF
        html2pdf().from(docState.element).set(options).save().then(() => {
            restoreDocumentAfterPDF(docState);
        });
    });
    
    // Save to Cloudinary button click handler
    document.getElementById('save_to_cloudinary').addEventListener('click', function() {
        const docState = prepareDocumentForPDF();
        if (!docState) return;
        
        // Show loading indicator
        const loadingToast = document.createElement('div');
        loadingToast.className = 'fixed bottom-5 right-5 bg-blue-500 text-white text-base px-6 py-3 rounded-xl shadow-lg transition-opacity duration-300';
        loadingToast.textContent = 'Saving to Cloudinary...';
        document.body.appendChild(loadingToast);
        
        // Options for generating PDF
        const options = {
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
            pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
        };

        // Generate the PDF as blob
        html2pdf().from(docState.element).set(options).outputPdf('datauristring').then(pdfDataUri => {
            // Send the PDF data to the server
            fetch('{% url "reporting:save_pdf_to_cloudinary" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    pdf_data: pdfDataUri,
                    sap_id: '{{employee.SAP_ID}}',
                    file_name: '{{employee.name}}_leave_memorandum.pdf'
                })
            })
            .then(response => response.json())
            .then(data => {
                // Remove loading toast
                document.body.removeChild(loadingToast);
                
                // Show success or error toast
                const toast = document.createElement('div');
                if (data.success) {
                    toast.className = 'fixed bottom-5 right-5 bg-green-500 text-white text-base px-6 py-3 rounded-xl shadow-lg transition-opacity duration-300';
                    toast.textContent = 'Successfully saved to Cloudinary!';
                } else {
                    toast.className = 'fixed bottom-5 right-5 bg-red-500 text-white text-base px-6 py-3 rounded-xl shadow-lg transition-opacity duration-300';
                    toast.textContent = 'Error: ' + (data.error || 'Failed to save to Cloudinary');
                }
                document.body.appendChild(toast);
                
                // Remove toast after 3 seconds
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 3000);
            })
            .catch(error => {
                // Remove loading toast
                document.body.removeChild(loadingToast);
                
                // Show error toast
                const toast = document.createElement('div');
                toast.className = 'fixed bottom-5 right-5 bg-red-500 text-white text-base px-6 py-3 rounded-xl shadow-lg transition-opacity duration-300';
                toast.textContent = 'Error: ' + error.message;
                document.body.appendChild(toast);
                
                // Remove toast after 3 seconds
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 3000);
            })
            .finally(() => {
                restoreDocumentAfterPDF(docState);
            });
        });
    });

    // Date formatting 

    function formatDate(inputId, outputId) {
        const inputField = document.getElementById(inputId);
        const outputField = document.getElementById(outputId);
        
        // Check if both elements exist before proceeding
        if (!inputField || !outputField) {
            console.warn(`formatDate: Element with ID ${!inputField ? inputId : outputId} not found`);
            return; // Exit the function if either element doesn't exist
        }
    
        function updateDate() {
            const inputDate = new Date(inputField.value);
            if (!isNaN(inputDate.getTime())) {
                const formattedDate = new Intl.DateTimeFormat('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                }).format(inputDate);
                outputField.textContent = formattedDate;
                outputField.setAttribute('data-formatted-date', formattedDate);
            } else {
                outputField.textContent = "______________";
                outputField.removeAttribute('data-formatted-date');
            }
        }
    
        // Set default value to today's date in YYYY-MM-DD format
        const today = new Date();
        const todayFormatted = today.toISOString().split('T')[0]; // Format: YYYY-MM-DD
        inputField.value = todayFormatted;
        
        updateDate(); // Display formatted date immediately
    
        inputField.addEventListener('change', updateDate);
    }

    // Apply formatting to both date inputs
    formatDate('application_date', 'application_date_text');
    formatDate('effect_from', 'effect_from_text');
    formatDate('effect_to', 'effect_to_text');
    
    // Function to calculate effect_to date based on granted leaves and effect_from date
    function calculateEffectToDate() {
        const grantedLeavesInput = document.getElementById('granted_leaves');
        const effectFromInput = document.getElementById('effect_from');
        const effectToInput = document.getElementById('effect_to');
        
        if (grantedLeavesInput && effectFromInput && effectToInput) {
            const grantedLeaves = parseInt(grantedLeavesInput.value, 10);
            const effectFromDate = new Date(effectFromInput.value);
            
            if (!isNaN(grantedLeaves) && grantedLeaves > 0 && !isNaN(effectFromDate.getTime())) {
                // Calculate the effect_to date by adding granted leaves - 1 days to effect_from
                // We subtract 1 because the leave period includes both the start and end dates
                const effectToDate = new Date(effectFromDate);
                effectToDate.setDate(effectFromDate.getDate() + (grantedLeaves - 1));
                
                // Format the date as YYYY-MM-DD for the input field
                const effectToFormatted = effectToDate.toISOString().split('T')[0];
                effectToInput.value = effectToFormatted;
                
                // Trigger the change event to update the formatted display
                const event = new Event('change');
                effectToInput.dispatchEvent(event);
            }
        }
    }
    
    // Add event listeners to recalculate effect_to when granted_leaves or effect_from changes
    document.getElementById('granted_leaves').addEventListener('input', calculateEffectToDate);
    document.getElementById('effect_from').addEventListener('change', calculateEffectToDate);


    document.getElementById('leave_type_option').addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        const leaveTypeCode = selectedOption.getAttribute('data-code') || '';
        const leaveTypeName = selectedOption.text;
        
        // Update all leave type text elements with the full leave type name
        const leaveTypeTextElements = document.querySelectorAll('#leave_type_text');
        leaveTypeTextElements.forEach(element => {
            element.textContent = leaveTypeName || "______________";
        });
        
        // Toggle between extension policy and station permission based on leave type
        const extensionPolicySection = document.getElementById('extension_policy_section');
        const stationPermissionSection = document.getElementById('station_permission_section');
        
        if (leaveTypeCode === 'EX-Pak') {
            extensionPolicySection.style.display = 'block';
            stationPermissionSection.style.display = 'none';
        } else if (leaveTypeCode === 'SL') {
            // For Sick Leave, show both sections
            extensionPolicySection.style.display = 'block';
            stationPermissionSection.style.display = 'block';
        } else if (leaveTypeCode === 'ML') {
            // For Mandatory Leave, show extension policy only
            extensionPolicySection.style.display = 'block';
            stationPermissionSection.style.display = 'none';
        } else {
            // For other leave types (PL, CL)
            extensionPolicySection.style.display = 'none';
            stationPermissionSection.style.display = 'block';
        }
    });

    // Update purpose text in the document when purpose textarea changes
    document.getElementById('purpose').addEventListener('input', function() {
        const purposeText = document.getElementById('purpose_text');
        purposeText.textContent = this.value || "______________";
    });

    // numbers to Aplhabets
    function numberToWords(num) {
        const ones = ["", "One", "Two", "Three", "Four", "Five", "Six", "Seven", "Eight", "Nine"];
        const teens = ["Ten", "Eleven", "Twelve", "Thirteen", "Fourteen", "Fifteen", "Sixteen", "Seventeen", "Eighteen", "Nineteen"];
        const tens = ["", "", "Twenty", "Thirty", "Forty", "Fifty", "Sixty", "Seventy", "Eighty", "Ninety"];

        if (num === 0) return "Zero";

        let words = "";

        if (num < 10) {
            words = ones[num];
        } else if (num < 20) {
            words = teens[num - 10];
        } else if (num < 100) {
            words = tens[Math.floor(num / 10)] + (num % 10 !== 0 ? " " + ones[num % 10] : "");
        } else {
            words = ones[Math.floor(num / 100)] + " Hundred" + (num % 100 !== 0 ? " " + numberToWords(num % 100) : "");
        }

        return words;
    }

    // Fetch Data
    document.getElementById('granted_leaves').addEventListener('input', function() {
        let value = parseInt(this.value, 10);
        if (!isNaN(value) && value > 0) {
            const formattedValue = `${numberToWords(value)} (${value.toString().padStart(2, '0')}) day(s)`;
            document.getElementById('granted_leaves_text').textContent = formattedValue;
            document.getElementById('granted_leaves_text').setAttribute('data-formatted-value', formattedValue);
        } else {
            document.getElementById('granted_leaves_text').textContent = "______________";
            document.getElementById('granted_leaves_text').removeAttribute('data-formatted-value');
        }
    });


    // Event listener for the SAP ID search button
    document.getElementById('search_employee').addEventListener('click', function(event) {
        // Prevent form submission
        event.preventDefault();
        
        const sapId = document.getElementById('search_sap_id').value;

        if (sapId) {
            fetch(`/get_employee/?sap_id=${sapId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.employee_name && data.designation) {
                        // Update the letter preview with employee data
                        updateLetterWithEmployeeData(data, sapId);
                        // Fetch leave balances for this employee
                        fetchLeaveBalances(sapId);
                        showSuccessToast("Employee found!");
                    } else {
                        showErrorToast("Employee with this SAP ID not found!");
                        $('#leave-balance-section').addClass('hidden');
                    }
                })
                .catch(error => {
                    showErrorToast("Employee with this SAP ID not found!");
                    $('#leave-balance-section').addClass('hidden');
                });
        } else {
            showErrorToast("Please enter an SAP ID before searching.");
            $('#leave-balance-section').addClass('hidden');
        }
    });
    
    // Function to fetch leave balances
    function fetchLeaveBalances(sapId) {
        $.ajax({
            url: "{% url 'reporting:get_employee_leave_balance' %}",
            data: {
                'sap_id': sapId
            },
            dataType: 'json',
            success: function(data) {
                if (data.leave_balances && data.leave_balances.length > 0) {
                    // Show the leave balance section
                    $('#leave-balance-section').removeClass('hidden');
                    
                    // Clear previous balances
                    $('#leave-balances').empty();
                    
                    // Add each leave balance
                    data.leave_balances.forEach(function(balance) {
                        $('#leave-balances').append(`
                            <div class="p-3 bg-white rounded shadow-sm mb-2">
                                <div class="flex justify-between items-center">
                                    <span class="font-medium text-gray-800">${balance.leave_type_name}</span>
                                    <span class="text-sm bg-blue-100 text-blue-800 py-1 px-2 rounded">
                                        Available: ${balance.available_leaves}
                                    </span>
                                </div>
                                <div class="mt-2 grid grid-cols-2 gap-2 text-sm">
                                    <div>
                                        <span class="text-gray-500">Entitled:</span>
                                        <span class="ml-1">${balance.entitled_leaves}</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-500">Used:</span>
                                        <span class="ml-1">${balance.used_leaves}</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-500">Carried Forward:</span>
                                        <span class="ml-1">${balance.carried_forward_leaves}</span>
                                    </div>
                                    <div>
                                        <span class="text-gray-500">Frozen:</span>
                                        <span class="ml-1">${balance.frozen_leaves}</span>
                                    </div>
                                </div>
                            </div>
                        `);
                    });
                    
                    // Update leave balance display when leave type is selected
                    $('#leave_type_option').on('change', function() {
                        const selectedLeaveTypeId = $(this).val();
                        if (selectedLeaveTypeId) {
                            const selectedLeaveType = data.leave_balances.find(balance => 
                                balance.leave_type_id == selectedLeaveTypeId);
                            
                            if (selectedLeaveType) {
                                $('#leave_balance_display').html(`Available balance: <span class="font-semibold">${selectedLeaveType.available_leaves}</span>`);
                                
                                // Check if requested leaves exceed available balance
                                const grantedLeaves = parseInt($('#granted_leaves').val()) || 0;
                                if (grantedLeaves > selectedLeaveType.available_leaves) {
                                    showBalanceWarningToast();
                                }
                            } else {
                                $('#leave_balance_display').html('Available balance: <span class="font-semibold">--</span>');
                            }
                        } else {
                            $('#leave_balance_display').html('Available balance: <span class="font-semibold">--</span>');
                        }
                    });
                    
                    // Check balance when granted leaves are changed
                    $('#granted_leaves').on('input', function() {
                        const selectedLeaveTypeId = $('#leave_type_option').val();
                        if (selectedLeaveTypeId) {
                            const selectedLeaveType = data.leave_balances.find(balance => 
                                balance.leave_type_id == selectedLeaveTypeId);
                            
                            if (selectedLeaveType) {
                                const grantedLeaves = parseInt($(this).val()) || 0;
                                if (grantedLeaves > selectedLeaveType.available_leaves) {
                                    showBalanceWarningToast();
                                }
                            }
                        }
                    });
                } else {
                    // Hide the section if no balances
                    $('#leave-balance-section').addClass('hidden');
                }
            },
            error: function() {
                // Hide the section on error
                $('#leave-balance-section').addClass('hidden');
                showErrorToast("Error fetching leave balances");
            }
        });
    }
    
    // Function to update the letter with employee data
    function updateLetterWithEmployeeData(data, sapId) {
        // Update all employee-related fields in the letter
        const employeeNameElements = document.querySelectorAll('.employee-name');
        employeeNameElements.forEach(el => {
            el.textContent = data.employee_name;
        });
        
        const employeeDesignationElements = document.querySelectorAll('.employee-designation');
        employeeDesignationElements.forEach(el => {
            el.textContent = data.designation;
        });
        
        const employeeSapIdElements = document.querySelectorAll('.employee-sapid');
        employeeSapIdElements.forEach(el => {
            el.textContent = sapId;
        });
        
        // Update other employee-related fields if they exist
        if (data.employee_grade) {
            const employeeGradeElements = document.querySelectorAll('.employee-grade');
            employeeGradeElements.forEach(el => {
                el.textContent = data.employee_grade;
            });
        }
        
        if (data.employee_type) {
            const employeeTypeElements = document.querySelectorAll('.employee-type');
            employeeTypeElements.forEach(el => {
                el.textContent = data.employee_type;
            });
        }
        
        if (data.region) {
            const employeeRegionElements = document.querySelectorAll('.employee-region');
            employeeRegionElements.forEach(el => {
                el.textContent = data.region;
            });
        }
        
        // Update recipient information section
        const recipientSection = document.getElementById('recipient-information-section');
        if (recipientSection) {
            // Clear existing content
            recipientSection.innerHTML = '';
            
            // Create and append new elements with employee data
            const nameP = document.createElement('p');
            nameP.className = 'font-semibold';
            nameP.textContent = (data.employee_salutation ? data.employee_salutation + ' ' : '') + data.employee_name;
            recipientSection.appendChild(nameP);
            
            const gradeTypeP = document.createElement('p');
            gradeTypeP.className = 'text-sm';
            gradeTypeP.textContent = (data.employee_grade || '') + '/ ' + (data.employee_type || '');
            recipientSection.appendChild(gradeTypeP);
            
            const sapIdP = document.createElement('p');
            sapIdP.className = 'text-sm';
            sapIdP.textContent = 'SAP ID: ' + sapId;
            recipientSection.appendChild(sapIdP);
        }
        
        // Update form action URL if needed
        const form = document.getElementById('leave-application-form');
        if (form) {
            form.action = "{% url 'reporting:application_leave' '0' %}".replace('0', sapId);
        }
    }
    
    // Event listener for the first backup employee's "Fetch" button
    document.getElementById('fetch_employee_data').addEventListener('click', function(event) {
        // Prevent form submission
        event.preventDefault();
        
        const sapId = document.getElementById('absence_employee').value;

        if (sapId) {
            fetch(`/get_employee/?sap_id=${sapId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.employee_name && data.designation) {
                        document.getElementById('employee_backup_name').textContent = data.employee_name;
                        document.getElementById('employee_backup_designation').textContent = data.designation;
                        document.getElementById('employee_backup_sapID').textContent = sapId;
                        showSuccessToast("Employee found!");
                    } else {
                        resetPlaceholders();
                    }
                })
                .catch(error => {
                    showErrorToast("Employee with this SAP ID not found!");
                });
        } else {
            showErrorToast("Please enter an SAP ID before fetching data.");
        }
    });

    // Event listener for the second backup employee's "Fetch" button
    document.getElementById('fetch_employee_data2').addEventListener('click', function(event) {
        // Prevent form submission
        event.preventDefault();
        
        const sapId2 = document.getElementById('absence_employee2').value;

        if (sapId2) {
            fetch(`/get_employee/?sap_id=${sapId2}`)
                .then(response => response.json())
                .then(data => {
                    if (data.employee_name && data.designation) {
                        document.getElementById('employee_backup_name2').textContent = data.employee_name;
                        document.getElementById('employee_backup_designation2').textContent = data.designation;
                        document.getElementById('employee_backup_sapID2').textContent = sapId2;
                        showSuccessToast("Employee found!");
                    } else {
                        resetPlaceholders2();
                    }
                })
                .catch(error => {
                    showErrorToast("Employee with this SAP ID not found!");
                });
        } else {
            showErrorToast("Please enter an SAP ID before fetching data.");
        }
    });

    // Function to reset placeholders for the first backup employee
    function resetPlaceholders() {
        document.getElementById('employee_backup_name').textContent = "_____________";
        document.getElementById('employee_backup_designation').textContent = "_____________";
        document.getElementById('employee_backup_sapID').textContent = "_____________";
    }

    // Function to reset placeholders for the second backup employee
    function resetPlaceholders2() {
        document.getElementById('employee_backup_name2').textContent = "_____________";
        document.getElementById('employee_backup_designation2').textContent = "_____________";
        document.getElementById('employee_backup_sapID2').textContent = "_____________";
    }

    function showErrorToast(message) {
        const toast = document.getElementById('errorToast');
        toast.textContent = message;
        toast.classList.remove('hidden');
        toast.classList.add('opacity-100');

        setTimeout(() => {
            toast.classList.add('hidden');
        }, 3000);
    }

    function showSuccessToast(message) {
        const toast = document.getElementById('sucessToast');
        toast.textContent = message;
        toast.classList.remove('hidden');
        toast.classList.add('opacity-100');

        setTimeout(() => {
            toast.classList.add('hidden');
        }, 3000);
    }
    
    function showBalanceWarningToast() {
        const toast = document.getElementById('balanceWarningToast');
        toast.classList.remove('hidden');
        toast.classList.add('opacity-100');

        setTimeout(() => {
            toast.classList.add('hidden');
        }, 3000);
    }


    $(document).ready(function() {
    $('#form_type').on('change', function() {
        var sapId = $(this).val();
        if (sapId) {
            $.ajax({
                url: "{% url 'reporting:get_employee_data' %}", 
                data: {
                    'sap_id': sapId
                },
                dataType: 'json',
                success: function(data) {

                    // Update the employee details section with retrieved data
                    $('#employee-details').html(`
                        <p>_________________________</p>
                        <p class="font-semibold">${data.employee_name}</p>
                        <p class="text-sm">${data.grade}/${data.designation}</p>
                        <p class="text-sm">${data.wing} ${data.division} (${data.group})</p>
                    `);
                },
                error: function() {
                    $('#employee-details').html('<p class="text-red-500">Error loading data.</p>');
                }
            });
        } else {
            $('#employee-details').empty();
        }
    });
});


    document.querySelectorAll('input[name="extension"]').forEach((radio) => {
        radio.addEventListener("change", function () {
            if (this.value === "allowed") {
                document.getElementById("extension_text").textContent = 
                    "It is further advised that no extension in leave will be allowed to him/her under any circumstances.";
            } else {
                document.getElementById("extension_text").textContent = 
                    "";
            }
        });
    });
    
    // Handle station permission radio buttons
    document.querySelectorAll('input[name="station_permission"]').forEach((radio) => {
        radio.addEventListener("change", function () {
            if (this.value === "yes") {
                document.getElementById("extension_text").textContent = 
                    "with permission to leave the station";
            } else {
                document.getElementById("extension_text").textContent = 
                    "";
            }
        });
    });
   

</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.2/html2pdf.bundle.js"></script>
{% endblock content %}
